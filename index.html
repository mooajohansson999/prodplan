<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIASALES Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: linear-gradient(180deg, #ffffff 0%, #f3f2f0 100%); min-height: 100vh; color: #1a1a1a; font-size: 13px; }

  header {
    background: #fff; border-bottom: 1px solid #ebebeb;
    padding: 0 32px; height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, #f97c5a, #e8503a);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 14px;
  }
  .logo-text { font-weight: 600; font-size: 15px; letter-spacing: 0.5px; }

  .header-right { display: flex; align-items: center; gap: 10px; }
  .import-success { display: none; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; }
  .import-success.visible { display: flex; }
  .import-success.utfall { color: #e8503a; }
  .import-success.mal { color: #2d8a4e; }

  /* === MAIN NAV TABS === */
  .main-nav {
    display: flex; align-items: center; gap: 0;
    background: #f0f0ee; border-radius: 10px; padding: 3px; margin-left: 20px;
  }
  .main-nav-tab {
    padding: 7px 18px; border-radius: 8px; font-size: 13px; cursor: pointer;
    color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none;
    white-space: nowrap;
  }
  .main-nav-tab.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
  .main-nav-tab:hover:not(.active) { color: #333; }

  /* === BUTTONS === */
  .btn {
    display: flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 8px;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: background 0.15s; white-space: nowrap; border: 1px solid #ebebeb; background: #fff; color: #555;
  }
  .btn:hover { background: #f7f7f5; }
  .btn-primary { background: #f97c5a; color: white; border: none; }
  .btn-primary:hover { background: #e8503a; }

  /* === FILTER BAR === */
  .filter-bar {
    display: flex; align-items: center; gap: 10px; padding: 12px 24px;
    background: #fff; border-bottom: 1px solid #ebebeb;
    flex-wrap: wrap;
  }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-label { font-size: 11px; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-pills { display: flex; gap: 4px; background: #f0f0ee; border-radius: 8px; padding: 3px; }
  .filter-pill {
    padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer;
    color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none;
  }
  .filter-pill.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
  .filter-pill:hover:not(.active) { color: #333; }

  select {
    border: 1px solid #ebebeb; border-radius: 8px; padding: 6px 28px 6px 10px;
    font-size: 13px; font-weight: 500; background: #fff; color: #1a1a1a;
    cursor: pointer; outline: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23999'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
  }
  select:focus { border-color: #f97c5a; }

  .nav-btn {
    width: 28px; height: 28px; border: 1px solid #ebebeb; border-radius: 6px;
    background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: #555; transition: all 0.15s;
  }
  .nav-btn:hover { background: #f7f7f5; }

  /* === MODAL === */
  .modal-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(0,0,0,0.3); z-index: 1000;
    align-items: center; justify-content: center;
  }
  .modal-overlay.visible { display: flex; }
  .modal {
    background: #fff; border-radius: 16px;
    padding: 32px; width: 400px; box-shadow: 0 8px 40px rgba(0,0,0,0.15);
  }
  .modal h2 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
  .modal p { font-size: 12px; color: #999; margin-bottom: 20px; }
  .modal label { font-size: 12px; font-weight: 500; color: #555; display: block; margin-bottom: 6px; }
  .modal input[type=password], .modal input[type=file] {
    width: 100%; border: 1px solid #ebebeb; border-radius: 8px;
    padding: 9px 12px; font-size: 13px; outline: none; margin-bottom: 16px; background: #fafafa;
  }
  .modal input[type=password]:focus { border-color: #f97c5a; }
  .modal input[type=file] { padding: 7px 12px; cursor: pointer; }
  .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 4px; }
  .btn-cancel { padding: 8px 16px; border-radius: 8px; border: 1px solid #ebebeb; background: #fff; font-size: 13px; cursor: pointer; color: #555; }
  .btn-confirm { padding: 8px 16px; border-radius: 8px; border: none; background: #f97c5a; color: white; font-size: 13px; font-weight: 600; cursor: pointer; }
  .btn-confirm:hover { background: #e8503a; }
  .modal-error { font-size: 12px; color: #c0392b; margin-top: -10px; margin-bottom: 12px; display: none; }
  .modal-error.visible { display: block; }

  /* === CONTENT === */
  main { padding: 0; min-height: calc(100vh - 56px); }

  .page-section { padding: 20px 24px; }
  .page-title { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
  .page-sub { font-size: 11px; color: #999; margin-bottom: 14px; }

  /* === OVERVIEW CARDS === */
  .compare-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
  .compare-card {
    background: #fff; border: 1px solid #ebebeb; border-radius: 12px; padding: 18px;
    cursor: pointer; transition: box-shadow 0.15s, border-color 0.15s;
  }
  .compare-card:hover { border-color: #f97c5a; box-shadow: 0 2px 12px rgba(249,124,90,0.1); }
  .compare-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .compare-card-title { font-size: 14px; font-weight: 600; }
  .compare-badge { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }
  .badge-green { background: #e8f7ee; color: #2d8a4e; }
  .badge-red { background: #fdecea; color: #c0392b; }
  .badge-neutral { background: #f0f0f0; color: #666; }
  .compare-metric { margin-bottom: 12px; }
  .compare-metric-label { font-size: 11px; color: #1a1a1a; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; display: flex; justify-content: space-between; }
  .compare-metric-label span { color: #1a1a1a; font-weight: 600; font-size: 12px; text-transform: none; letter-spacing: 0; }
  .progress-bar-bg { height: 6px; background: #f0f0ee; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 10px; transition: width 0.4s ease; }
  .sparkline { margin-top: 14px; border-top: 1px solid #f0f0ee; padding-top: 10px; }
  .sparkline-label { font-size: 11px; color: #1a1a1a; margin-bottom: 6px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; }

  /* === STAT CARDS === */
  .stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
  .stat-card { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; padding: 10px 16px; }
  .stat-label { font-size: 10px; color: #1a1a1a; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 20px; font-weight: 600; }
  .stat-meta { font-size: 10px; color: #999; margin-top: 2px; }
  .stat-badge { display: inline-block; font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 20px; margin-top: 4px; }

  /* === TABLE === */
  .table-wrap { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; overflow: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: #fafafa; }
  th { padding: 6px 10px; text-align: center; font-size: 10px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #d0650a; white-space: nowrap; background: #f97c5a; }
  th.goal-col { background: #e8503a; }
  td { padding: 5px 10px; border-bottom: 1px solid #f5f5f5; font-size: 12px; color: #333; white-space: nowrap; text-align: center; }
  td.goal-col { background: #fafafa; }
  tr:last-child td { border-bottom: none; }
  tr.weekend td { background: #efefed; color: #bbb; }
  tr.weekend td.goal-col { background: #e8e8e6; }
  tr.last-data td, tr.last-data td.goal-col { background: #fff0eb !important; }
  tr.last-data td:first-child { border-left: 3px solid #f97c5a; }
  td.goal { color: #1a1a1a; font-size: 12px; font-weight: 500; }
  td.above { color: #2d8a4e; font-weight: 600; }
  td.below { color: #c0392b; font-weight: 600; }
  .day-badge { display: inline-block; font-size: 9px; font-weight: 600; color: #f97c5a; background: #fff5f3; border-radius: 3px; padding: 1px 5px; margin-right: 4px; }
  tr.summary-row td { font-weight: 700; color: #1a1a1a; border-top: 2px solid #e8503a; background: #fde0d8; font-size: 12px; }
  tr.summary-row td.goal-col { background: #f9cfc6; }
  .empty-cell { color: #ddd; }

  /* === DAILY PROJECT SELECTOR === */
  .project-selector { display: flex; gap: 6px; flex-wrap: wrap; }
  .proj-chip {
    padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer;
    border: 1px solid #ebebeb; background: #fff; color: #555; font-weight: 500;
    transition: all 0.15s;
  }
  .proj-chip.active { background: #f97c5a; color: #fff; border-color: #f97c5a; }
  .proj-chip:hover:not(.active) { border-color: #f97c5a; color: #e8503a; }

  /* === VIEW TABS (compact/full) === */
  .view-tabs { display: flex; gap: 4px; background: #f0f0ee; border-radius: 8px; padding: 3px; }
  .view-tab { padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none; }
  .view-tab.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

  .summary-card {
    background: #fff; border: 1px solid #ebebeb; border-radius: 14px; padding: 22px 28px;
    display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; align-items: start;
  }
  .summary-card .sc-block {}
  .summary-card .sc-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 4px; }
  .summary-card .sc-value { font-size: 22px; font-weight: 700; color: #1a1a1a; }
  .summary-card .sc-meta { font-size: 11px; color: #999; margin-top: 2px; }
  .summary-card .sc-badge { display: inline-block; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 20px; margin-top: 4px; }
  .summary-card .sc-spark { grid-column: 1 / -1; border-top: 1px solid #f0f0ee; padding-top: 14px; margin-top: 4px; }
  .summary-card .sc-spark-label { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; color: #1a1a1a; margin-bottom: 6px; }

  @media (max-width: 768px) {
    .summary-card { grid-template-columns: repeat(2, 1fr); gap: 14px; padding: 16px; }
    .summary-card .sc-value { font-size: 18px; }
    .summary-card .sc-spark { grid-column: 1 / -1; }
  }
  @media (max-width: 768px) {
    header { padding: 0 12px; height: 48px; }
    .logo-text { font-size: 13px; }
    .logo-icon { width: 28px; height: 28px; font-size: 12px; }
    .main-nav { margin-left: 10px; }
    .main-nav-tab { padding: 5px 12px; font-size: 12px; }
    .header-right { gap: 6px; }
    .header-right > div:not(.main-nav):not(.import-success) { display: none; }

    .filter-bar { padding: 10px 12px; gap: 8px; }
    .page-section { padding: 14px 12px; }
    .page-title { font-size: 15px; }

    .compare-grid { grid-template-columns: 1fr; gap: 10px; }
    .stat-cards { grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .stat-card { padding: 8px 12px; }
    .stat-value { font-size: 16px; }

    .project-selector { gap: 4px; }
    .proj-chip { padding: 4px 10px; font-size: 11px; }

    th { font-size: 9px; padding: 5px 6px; }
    td { font-size: 11px; padding: 4px 6px; }
  }
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo" style="display:flex;align-items:center;">
    <div class="logo-icon">V</div>
    <span class="logo-text">VIASALES</span>
    <div class="main-nav" id="mainNav">
      <button class="main-nav-tab active" onclick="switchPage('overview')">üìä √ñversikt</button>
      <button class="main-nav-tab" onclick="switchPage('daily')">üìÖ Daglig uppf√∂ljning</button>
    </div>
  </div>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#666;">
      <svg viewBox="0 0 20 20" fill="currentColor" width="13" height="13"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
      <span id="lastSynced">Senast synkad: ‚Äî</span>
    </div>
  </div>
</header>

<main>
  <!-- ======== OVERVIEW PAGE ======== -->
  <div id="overviewPage">
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Visa:</span>
        <div class="filter-pills" id="overviewFilter">
          <button class="filter-pill active" onclick="setOverviewFilter('alla',this)">Alla</button>
          <button class="filter-pill" onclick="setOverviewFilter('d2d',this)">D2D</button>
          <button class="filter-pill" onclick="setOverviewFilter('tm',this)">TM</button>
        </div>
      </div>
      <div class="filter-group">
        <span class="filter-label">Projekt:</span>
        <div class="project-selector" id="overviewProjectSelector"></div>
      </div>
      <div class="filter-group" style="margin-left:auto;">
        <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
        <select id="monthSel" onchange="renderCurrent()">
          <option value="0">Januari</option><option value="1" selected>Februari</option>
          <option value="2">Mars</option><option value="3">April</option>
          <option value="4">Maj</option><option value="5">Juni</option>
          <option value="6">Juli</option><option value="7">Augusti</option>
          <option value="8">September</option><option value="9">Oktober</option>
          <option value="10">November</option><option value="11">December</option>
        </select>
        <select id="yearSel" onchange="renderCurrent()">
          <option value="2024">2024</option><option value="2025">2025</option>
          <option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
    </div>
    <div class="page-section">
      <div class="page-title">√ñversikt</div>
      <div class="page-sub" id="overviewSub">Februari 2026</div>
      <div id="overviewSummaryCard"></div>
      <div id="overviewGrid" class="compare-grid" style="margin-top:14px;"></div>
    </div>
  </div>

  <!-- ======== DAILY PAGE ======== -->
  <div id="dailyPage" style="display:none;">
    <div class="filter-bar">
      <div class="filter-group">
        <span class="filter-label">Filter:</span>
        <div class="filter-pills" id="dailyGroupFilter">
          <button class="filter-pill active" onclick="setDailyGroupFilter('d2d',this)">D2D</button>
          <button class="filter-pill" onclick="setDailyGroupFilter('tm',this)">TM</button>
        </div>
      </div>
      <div class="filter-group">
        <span class="filter-label">Projekt:</span>
        <div class="project-selector" id="dailyProjectSelector"></div>
      </div>
      <div class="filter-group" style="margin-left:auto;">
        <div class="view-tabs">
          <button class="view-tab active" onclick="setDailyView('full',this)">Alla kolumner</button>
          <button class="view-tab" onclick="setDailyView('compact',this)">Kompakt</button>
        </div>
      </div>
    </div>
    <div class="filter-bar" style="border-bottom:none;padding-top:0;">
      <div class="filter-group">
        <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
        <select id="monthSel2" onchange="syncMonthFrom(this);renderCurrent()">
          <option value="0">Januari</option><option value="1" selected>Februari</option>
          <option value="2">Mars</option><option value="3">April</option>
          <option value="4">Maj</option><option value="5">Juni</option>
          <option value="6">Juli</option><option value="7">Augusti</option>
          <option value="8">September</option><option value="9">Oktober</option>
          <option value="10">November</option><option value="11">December</option>
        </select>
        <select id="yearSel2" onchange="syncYearFrom(this);renderCurrent()">
          <option value="2024">2024</option><option value="2025">2025</option>
          <option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
    </div>
    <div class="page-section" style="padding-top:0;">
      <div class="stat-cards" id="dailyStatCards">
        <div class="stat-card">
          <div class="stat-label">Utfall produkter</div>
          <div class="stat-value" id="sc-prod">‚Äî</div>
          <div class="stat-meta" id="sc-prod-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-prod-badge">Ingen data</div>
          <div id="sc-prod-takt" style="font-size:11px;margin-top:4px;"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Snitt per dag</div>
          <div class="stat-value" id="sc-avg">‚Äî</div>
          <div class="stat-meta" id="sc-avg-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-avg-badge">Ingen data</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Snitt per timme</div>
          <div class="stat-value" id="sc-phtimme">‚Äî</div>
          <div class="stat-meta" id="sc-phtimme-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-phtimme-badge">Ingen data</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">S√§ljare per dag</div>
          <div class="stat-value" id="sc-sellers">‚Äî</div>
          <div class="stat-meta" id="sc-sellers-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-sellers-badge">Ingen data</div>
        </div>
      </div>
      <div class="table-wrap" id="tableWrap">
        <table><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
      </div>
    </div>
  </div>
</main>

<script>
const MONTHS_SV=['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September','Oktober','November','December'];
const DAYS_SV=['S√∂ndag','M√•ndag','Tisdag','Onsdag','Torsdag','Fredag','L√∂rdag'];
const GROUP_D2D=['telia-fm','villafiber','koax','lan'];
const GROUP_TM=['globalconnect','adressandring','vip-leads','retention','mbh','mobil','fmc'];
const ALL_PROJECTS=[...GROUP_D2D,...GROUP_TM];
const MANSDAG_PROJECTS=new Set(['telia-fm','villafiber','koax','lan','globalconnect']);
const SNITT_PER_TIMMAR=new Set(['adressandring','vip-leads','retention','mbh','mobil','fmc']);

const PROJECT_META={
  'telia-fm':{name:'Telia FM',sheet:'1.1. Telia D2D'},
  'villafiber':{name:'Villafiber',sheet:'1.3. Tele2 Villafiber'},
  'koax':{name:'Koax',sheet:'1.2. Tele2 Koax'},
  'lan':{name:'LAN',sheet:'1.4. LAN'},
  'globalconnect':{name:'GlobalConnect',sheet:'GlobalConnect'},
  'adressandring':{name:'Telia Adress√§ndring',sheet:'2.7. Telia Adress√§ndring'},
  'vip-leads':{name:'Telia VIP Leads',sheet:'2.6. Telia VIP Leads'},
  'retention':{name:'Telia Retention',sheet:'2.5. Telia Retention Leads'},
  'mbh':{name:'Telia MBH',sheet:'2.2. Telia MBH'},
  'mobil':{name:'Telia Mobil',sheet:'2.2. Telia Mobil'},
  'fmc':{name:'Telia FMC',sheet:'2.2.1. Telia FMC'}
};

let currentPage='overview';
let overviewFilter='alla';
let overviewProject=null; // null = visa alla
let dailyGroup='d2d';
let dailyProject='telia-fm';
let dailyView='full';
let utfallData={};
let malData={};

// === PROJECT COLUMN DEFINITIONS ===
const COMPACT_COLS=[
  {label:'Dag'},{label:'Datum'},
  {label:'M√•l s√§ljare',goalKey:'__mal_saljare__'},{label:'Utfall s√§ljare',key:'__utfall_saljare__'},
  {label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},
  {label:'M√•l Produkt',goalKey:'__mal_prod__'},{label:'Utfall Produkt',key:'Produkt'}
];

const PROJECT_COLS={
  'telia-fm':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l S√§lj',goalKey:'M√•l S√§lj'},{label:'Utfall Produkter',key:'Produkt'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall Timmar',key:'Utfall Timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Premium',goalKey:'M√•l Premium'},{label:'Utfall Premium',key:'Streaming'},{label:'M√•l Mob',goalKey:'M√•l Mob'},{label:'Utfall Mob',key:'MOBIL'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'villafiber':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'koax':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'lan':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'globalconnect':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'Utfall / densi',key:'Utfall / densi (Enligt orderfil)'},{label:'Utfall bygg / nytt',key:'Utfall bygg / nytt (Enligt orderfil)'},{label:'PTS24',key:'PTS24'},{label:'Utfall MDU:er',key:'Utfall MDU:er'},{label:'Utfall total',key:'Utfall total (Enligt orderfil)'},{label:'I S√§ljark',key:'I S√§ljarket'},{label:'Diff',key:'Diff Orderfil mot s√§ljark'},{label:'√Önger',key:'√Önger'},{label:'Bortfall',key:'Bortfall'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'adressandring':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal S√§ljare'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l produkt',goalKey:'M√•l produkt'},{label:'Utfall Produkt',key:'produkt'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l Flytt BB',goalKey:'M√•l Flytt BB'},{label:'Utfall Flytt BB',key:'Flytt Bredband'},{label:'M√•l MBH',goalKey:'M√•l MBH'},{label:'Utfall MBH',key:'MBH'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'vip-leads':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal S√§ljare'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l MBH',goalKey:'M√•l MBH'},{label:'Utfall MBH',key:'MBH'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'retention':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l Nyteck TV',goalKey:'M√•l Nyteck TV'},{label:'Utfall Nyteck TV',key:'TV FL'},{label:'Utfall F√∂rl√§ngning TV',key:'TV BOX'},{label:'M√•l premium',goalKey:'M√•l premium'},{label:'Utfall premium',key:'Streaming'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'mbh':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'mobil':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l Huvudabb',goalKey:'M√•l Huvudabb'},{label:'Utfall Huvudabb',key:'Mobil'},{label:'M√•l EA',goalKey:'M√•l EA'},{label:'Utfall EA',key:'EA'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'fmc':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l Huvudabb',goalKey:'M√•l Huvudabb'},{label:'Utfall Huvudabb',key:'Mobil'},{label:'M√•l EA',goalKey:'M√•l EA'},{label:'Utfall EA',key:'EA'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}]
};

// === HELPERS ===
function getMonth(){ return parseInt(document.getElementById('monthSel').value); }
function getYear(){ return parseInt(document.getElementById('yearSel').value); }
function syncMonthFrom(sel){ document.getElementById('monthSel').value=sel.value; }
function syncYearFrom(sel){ document.getElementById('yearSel').value=sel.value; }
function changeMonth(dir){
  let m=getMonth()+dir, y=getYear();
  if(m<0){m=11;y--;} if(m>11){m=0;y++;}
  document.getElementById('monthSel').value=m;
  document.getElementById('yearSel').value=y;
  document.getElementById('monthSel2').value=m;
  document.getElementById('yearSel2').value=y;
  renderCurrent();
}
function toDateKey(y,m,d){ return `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; }
function storeKey(proj,y,m){ return `${proj}_${y}_${m}`; }
function fmt2(v){ return typeof v==='number'?parseFloat(v.toFixed(2)):v; }
function isWeekend(d){ return d.getDay()===0||d.getDay()===6; }
function findVal(obj,key){
  if(!obj||!key) return null;
  const lk=key.toLowerCase();
  for(const k of Object.keys(obj)){ if(k.toLowerCase()===lk) return obj[k]; }
  return null;
}

function resolveDynGoal(goalKey,mRow){
  if(goalKey==='__mal_saljare__'){
    for(const k of ['M√•l s√§ljare','M√•l mansdagar']){ const v=findVal(mRow,k); if(typeof v==='number') return v; }
    return null;
  }
  if(goalKey==='__mal_prod__'){
    const p=dailyProject;
    if(p==='mobil'||p==='fmc'){ const h=findVal(mRow,'M√•l Huvudabb')??0, ea=findVal(mRow,'M√•l EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0)||null; }
    if(p==='vip-leads'){ const bb=findVal(mRow,'M√•l BB')??0, mbh=findVal(mRow,'M√•l MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0)||null; }
    if(p==='retention'||p==='mbh'){ const v=findVal(mRow,'M√•l BB'); return typeof v==='number'?v:null; }
    for(const k of ['M√•l S√§lj','M√•l Produkt','M√•l produkt','M√•l s√§lj']){ const v=findVal(mRow,k); if(typeof v==='number') return v; }
    return null;
  }
  return findVal(mRow,goalKey);
}

function getProjectMalProd(proj,mRow){
  const nr=normalizeRow(mRow,'mal');
  if(proj==='mobil'||proj==='fmc'){ const h=findVal(nr,'M√•l Huvudabb')??0, ea=findVal(nr,'M√•l EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0); }
  if(proj==='vip-leads'){ const bb=findVal(nr,'M√•l BB')??0, mbh=findVal(nr,'M√•l MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0); }
  if(proj==='retention'||proj==='mbh'){ const v=findVal(nr,'M√•l BB'); return typeof v==='number'?v:0; }
  const v=findVal(nr,'M√•l S√§lj'); return typeof v==='number'?v:0;
}

function normalizeRow(row,type){
  const out={};
  const km=type==='utfall'?{'produkt':'Produkt','timmar':'Timmar','utfall timmar':'Timmar','antal s√§ljare':'Antal Mansdagar'}:{'m√•l mansdagar':'M√•l s√§ljare','m√•l produkt':'M√•l S√§lj','m√•l s√§lj':'M√•l S√§lj','m√•l snitt per mansdag':'M√•l snitt'};
  for(const [k,v] of Object.entries(row)){
    const mapped=km[k.toLowerCase()]; const tk=mapped||k;
    if(out[tk]!==undefined){ if(typeof v==='number'&&typeof out[tk]==='number') out[tk]+=v; }
    else out[tk]=v;
  }
  return out;
}

function calcSnitt(proj,uRow){
  const prod=findVal(uRow,'Produkt')??findVal(uRow,'produkt')??null;
  if(typeof prod!=='number') return null;
  if(SNITT_PER_TIMMAR.has(proj)){
    const t=findVal(uRow,'Timmar')??findVal(uRow,'timmar')??null;
    return (typeof t==='number'&&t>0)?fmt2(prod/t):null;
  } else {
    const s=findVal(uRow,'Antal Mansdagar')??findVal(uRow,'Antal S√§ljare')??null;
    return (typeof s==='number'&&s>0)?fmt2(prod/s):null;
  }
}

function findGoalKey(cols,utfallKey){
  for(let i=0;i<cols.length;i++){
    if(cols[i].key&&cols[i].key.toLowerCase()===utfallKey.toLowerCase()){
      if(i>0&&cols[i-1].goalKey) return cols[i-1].goalKey;
    }
  }
  return null;
}

function getCompactProd(proj,row){
  if(proj==='vip-leads'){ const bb=findVal(row,'Bredband')??0, mbh=findVal(row,'MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0); }
  if(proj==='retention'||proj==='mbh') return findVal(row,'Bredband')??findVal(row,'BB')??null;
  if(proj==='mobil'||proj==='fmc'){ const h=findVal(row,'Mobil')??0, ea=findVal(row,'EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0); }
  return findVal(row,'Produkt')??findVal(row,'produkt')??null;
}

function generateDummyData(proj,m,y){
  const days=new Date(y,m+1,0).getDate();
  const uData={},mData={};
  const seeds={'telia-fm':{s:8,t:60,p:18},'villafiber':{s:5,t:38,p:10},'koax':{s:4,t:30,p:8},'lan':{s:3,t:22,p:6},'globalconnect':{s:6,t:45,p:12},'adressandring':{s:7,t:52,p:15},'vip-leads':{s:5,t:40,p:11},'retention':{s:6,t:44,p:13},'mbh':{s:4,t:32,p:9},'mobil':{s:5,t:38,p:10},'fmc':{s:3,t:24,p:7}};
  const seed=seeds[proj]||{s:5,t:40,p:10};
  for(let i=1;i<=days;i++){
    const d=new Date(y,m,i); if(d.getDay()===0||d.getDay()===6) continue;
    const dk=toDateKey(y,m,i), v=0.7+Math.random()*0.6;
    uData[dk]={'Antal Mansdagar':seed.s,'timmar':Math.round(seed.t*v),'Produkt':Math.round(seed.p*v),'snitt':parseFloat((seed.p*v/seed.s).toFixed(2))};
    mData[dk]={'M√•l s√§ljare':seed.s,'M√•l timmar':seed.t,'M√•l S√§lj':seed.p,'M√•l snitt':parseFloat((seed.p/seed.s).toFixed(2))};
  }
  return {uData,mData};
}

function getProjectData(proj){
  const m=getMonth(),y=getYear();
  let u=utfallData[storeKey(proj,y,m)]||{}, ml=malData[storeKey(proj,y,m)]||{};
  if(!Object.keys(u).length&&!Object.keys(ml).length){ const d=generateDummyData(proj,m,y); u=d.uData; ml=d.mData; }
  return {uData:u,mData:ml};
}

// === PAGE SWITCHING ===
function switchPage(page){
  currentPage=page;
  document.querySelectorAll('.main-nav-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.main-nav-tab').forEach(t=>{ if((page==='overview'&&t.textContent.includes('√ñversikt'))||(page==='daily'&&t.textContent.includes('Daglig'))) t.classList.add('active'); });
  document.getElementById('overviewPage').style.display=page==='overview'?'':'none';
  document.getElementById('dailyPage').style.display=page==='daily'?'':'none';
  renderCurrent();
}

function switchToDaily(proj){
  const group=GROUP_D2D.includes(proj)?'d2d':'tm';
  dailyGroup=group;
  dailyProject=proj;
  document.querySelectorAll('#dailyGroupFilter .filter-pill').forEach(p=>{ p.classList.toggle('active',p.textContent.toLowerCase()===group); });
  buildProjectChips();
  switchPage('daily');
}

function renderCurrent(){
  if(currentPage==='overview') renderOverview();
  else renderDaily();
}

// === OVERVIEW FILTER ===
function setOverviewFilter(f,el){
  overviewFilter=f;
  overviewProject=null;
  document.querySelectorAll('#overviewFilter .filter-pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  buildOverviewProjectChips();
  renderOverview();
}

function buildOverviewProjectChips(){
  const projs=overviewFilter==='d2d'?GROUP_D2D:overviewFilter==='tm'?GROUP_TM:ALL_PROJECTS;
  const sel=document.getElementById('overviewProjectSelector');
  sel.innerHTML=`<button class="proj-chip ${overviewProject===null?'active':''}" onclick="selectOverviewProject(null,this)">Alla</button>`+projs.map(p=>`<button class="proj-chip ${p===overviewProject?'active':''}" onclick="selectOverviewProject('${p}',this)">${PROJECT_META[p]?.name||p}</button>`).join('');
}

function selectOverviewProject(p,el){
  overviewProject=p;
  document.querySelectorAll('#overviewProjectSelector .proj-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderOverview();
}

// === OVERVIEW RENDER ===
function renderOverview(){
  const m=getMonth(),y=getYear();
  document.getElementById('overviewSub').textContent=`${MONTHS_SV[m]} ${y}`;
  let projects=ALL_PROJECTS;
  if(overviewFilter==='d2d') projects=GROUP_D2D;
  if(overviewFilter==='tm') projects=GROUP_TM;
  const singleProject=overviewProject?[overviewProject]:null;
  const cardProjects=singleProject||projects;

  const barColor=p=>p>=100?'#2d8a4e':'#f97c5a';
  const MAL_COLOR='#999';

  // === SUMMARY CARD (aggregera alla synliga projekt) ===
  let sumTotalProd=0,sumMalProd=0,sumTotalMansdag=0,sumMalMansdag=0,sumTotalTimmar=0,sumMalTimmar=0,sumWorkDays=0;
  let sumMalSnitt=0,sumMalSnittCount=0;
  const allSparkU=[],allSparkM=[];
  const days=new Date(y,m+1,0).getDate();

  // init spark arrays
  let sparkLen=0;
  for(let i=1;i<=days;i++){const d=new Date(y,m,i);if(d.getDay()!==0&&d.getDay()!==6) sparkLen++;}
  for(let i=0;i<sparkLen;i++){allSparkU.push(0);allSparkM.push(0);}

  cardProjects.forEach(proj=>{
    const {uData,mData}=getProjectData(proj);
    const uRows=Object.values(uData).map(r=>normalizeRow(r,'utfall'));
    const mRows=Object.values(mData);
    const mRowsNorm=mRows.map(r=>normalizeRow(r,'mal'));
    sumTotalProd+=uRows.reduce((s,r)=>{const v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalProd+=mRows.reduce((s,r)=>s+getProjectMalProd(proj,r),0);
    sumTotalMansdag+=uRows.reduce((s,r)=>{const v=findVal(r,'Antal Mansdagar')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalMansdag+=mRowsNorm.reduce((s,r)=>{const v=findVal(r,'M√•l s√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
    sumTotalTimmar+=uRows.reduce((s,r)=>{const v=findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalTimmar+=mRowsNorm.reduce((s,r)=>{const v=findVal(r,'M√•l timmar')??0;return s+(typeof v==='number'?v:0);},0);
    sumWorkDays=Math.max(sumWorkDays,uRows.filter(r=>(findVal(r,'Antal Mansdagar')??0)>0).length);
    mRowsNorm.forEach(r=>{const v=findVal(r,'M√•l snitt')??0;if(typeof v==='number'&&v>0){sumMalSnitt+=v;sumMalSnittCount++;}});

    // Accumulate sparklines
    let si=0;
    for(let i=1;i<=days;i++){
      const d=new Date(y,m,i);if(d.getDay()===0||d.getDay()===6) continue;
      const dk=toDateKey(y,m,i),ur=normalizeRow(uData[dk]||{},'utfall');
      allSparkU[si]+=(findVal(ur,'Produkt')??0);
      allSparkM[si]+=getProjectMalProd(proj,mData[dk]||{});
      si++;
    }
  });

  const sumProdPct=sumMalProd>0?Math.round(sumTotalProd/sumMalProd*100):0;
  const sumAvgProd=sumWorkDays>0?fmt2(sumTotalProd/sumWorkDays):0;
  const sumMalAvgSnitt=sumMalSnittCount>0?fmt2(sumMalSnitt/sumMalSnittCount):0;
  const sumSnittPerTimme=sumTotalTimmar>0?fmt2(sumTotalProd/sumTotalTimmar):0;
  const sumAvgSellers=sumWorkDays>0?fmt2(sumTotalMansdag/sumWorkDays):0;

  // Takt
  const sumMalDaysTotal=sumMalMansdag>0?(() => {
    let maxDays=0;
    cardProjects.forEach(proj=>{
      const {mData}=getProjectData(proj);
      const mRowsNorm=Object.values(mData).map(r=>normalizeRow(r,'mal'));
      const d=mRowsNorm.filter(r=>{const v=findVal(r,'M√•l s√§ljare')??0;return typeof v==='number'&&v>0;}).length;
      maxDays=Math.max(maxDays,d);
    });
    return maxDays;
  })():0;
  let taktHtml='';
  if(sumWorkDays>0&&sumMalProd>0&&sumMalDaysTotal>0){
    const expected=sumMalProd*(sumWorkDays/sumMalDaysTotal),diff=sumTotalProd-expected,diffPct=Math.round((diff/expected)*100);
    taktHtml=diff>=0?`<div style="font-size:11px;margin-top:4px;"><span style="color:#2d8a4e;font-weight:600;">‚ñ≤ On track</span> <span style="color:#666;">(+${Math.round(diff)} / +${diffPct}%)</span></div>`:`<div style="font-size:11px;margin-top:4px;"><span style="color:#c0392b;font-weight:600;">‚ñº Off track</span> <span style="color:#666;">(${Math.round(diff)} / ${diffPct}%)</span></div>`;
  }

  // Sparkline
  const maxSpark=Math.max(...allSparkU,...allSparkM,1);
  const W=900,H=52,n=allSparkU.length;
  const px=i=>n>1?(i/(n-1))*W:W/2;
  const py=v=>H-(v/maxSpark)*(H-4)-2;
  const malPath=allSparkM.map((v,i)=>`${i===0?'M':'L'}${px(i).toFixed(1)},${py(v).toFixed(1)}`).join(' ');
  const utfPath=allSparkU.map((v,i)=>`${i===0?'M':'L'}${px(i).toFixed(1)},${py(v).toFixed(1)}`).join(' ');
  const lineColor=sumProdPct>=100?'#2d8a4e':'#f97c5a';

  const filterLabel=overviewProject?PROJECT_META[overviewProject]?.name:overviewFilter==='d2d'?'D2D':overviewFilter==='tm'?'TM':'Alla projekt';

  const summaryHtml=`<div class="summary-card">
    <div class="sc-block">
      <div class="sc-label">Produkter totalt</div>
      <div class="sc-value">${sumTotalProd}</div>
      <div class="sc-meta">M√•l: ${sumMalProd>0?sumMalProd:'‚Äî'}</div>
      <div class="sc-badge ${sumProdPct>=100?'badge-green':sumMalProd>0?'badge-red':'badge-neutral'}">${sumMalProd>0?sumProdPct+'% av m√•l':'M√•l saknas'}</div>
      ${taktHtml}
    </div>
    <div class="sc-block">
      <div class="sc-label">Snitt per dag</div>
      <div class="sc-value">${sumAvgProd}</div>
      <div class="sc-meta">M√•l snitt: ${sumMalAvgSnitt>0?sumMalAvgSnitt:'‚Äî'}</div>
    </div>
    <div class="sc-block">
      <div class="sc-label">Snitt per timme</div>
      <div class="sc-value">${sumSnittPerTimme}</div>
      <div class="sc-meta">Totalt ${fmt2(sumTotalTimmar)} timmar</div>
    </div>
    <div class="sc-block">
      <div class="sc-label">S√§ljare per dag (snitt)</div>
      <div class="sc-value">${sumAvgSellers}</div>
      <div class="sc-meta">Totalt ${sumTotalMansdag} mansdagar</div>
    </div>
    <div class="sc-spark">
      <div class="sc-spark-label">${filterLabel} ‚Äì daglig produkt, utfall vs m√•l</div>
      <svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" style="overflow:visible">
        ${sumMalProd>0?`<path d="${malPath}" fill="none" stroke="${MAL_COLOR}" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/>`:''}<path d="${utfPath}" fill="none" stroke="${lineColor}" stroke-width="2"/>
      </svg>
      <div style="display:flex;gap:12px;margin-top:5px;font-size:10px;color:#999;">
        <span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:2px;background:${lineColor};border-radius:2px"></span>Utfall</span>
        ${sumMalProd>0?`<span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:0;border-top:2px dashed ${MAL_COLOR}"></span>M√•l</span>`:''}
      </div>
    </div>
  </div>`;

  document.getElementById('overviewSummaryCard').innerHTML=summaryHtml;

  // === PROJECT CARDS (skip if only one project selected) ===
  if(singleProject){
    document.getElementById('overviewGrid').innerHTML='';
    return;
  }

  const sorted=cardProjects.map(proj=>{
    const {uData,mData}=getProjectData(proj);
    const uRows=Object.values(uData).map(r=>normalizeRow(r,'utfall'));
    const mRows=Object.values(mData);
    const totalProd=uRows.reduce((s,r)=>{const v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    const malProd=mRows.reduce((s,r)=>s+getProjectMalProd(proj,r),0);
    return {proj,totalProd,malProd,pct:malProd>0?Math.round(totalProd/malProd*100):0,hasMal:malProd>0,uData,mData,uRows,mRows};
  }).sort((a,b)=>b.pct-a.pct);

  const cards=sorted.map(({proj,totalProd,malProd,pct:prodPct,hasMal:projHasMal,uData,mData,uRows,mRows})=>{
    const name=PROJECT_META[proj]?.name||proj;
    const useMansdag=MANSDAG_PROJECTS.has(proj);
    const mRowsNorm=mRows.map(r=>normalizeRow(r,'mal'));

    const totalMansdag=uRows.reduce((s,r)=>{const v=findVal(r,'Antal Mansdagar')??0;return s+(typeof v==='number'?v:0);},0);
    const malMansdag=mRowsNorm.reduce((s,r)=>{const v=findVal(r,'M√•l s√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
    const totalTimmar=uRows.reduce((s,r)=>{const v=findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
    const malTimmar=mRowsNorm.reduce((s,r)=>{const v=findVal(r,'M√•l timmar')??0;return s+(typeof v==='number'?v:0);},0);
    const workDays=uRows.filter(r=>(findVal(r,'Antal Mansdagar')??0)>0).length;
    const avgSellers=workDays>0?fmt2(totalMansdag/workDays):0;
    const snittpMansdag=useMansdag?(totalMansdag>0?fmt2(totalProd/totalMansdag):0):(totalTimmar>0?fmt2(totalProd/totalTimmar):0);
    const malSnittSum=mRowsNorm.reduce((s,r)=>{const v=findVal(r,'M√•l snitt')??0;return s+(typeof v==='number'?v:0);},0);
    const malSnittDays=mRowsNorm.filter(r=>(findVal(r,'M√•l snitt')??0)>0).length;
    const malSnitt=malSnittDays>0?fmt2(malSnittSum/malSnittDays):0;

    const secondPct=useMansdag?(malMansdag>0?Math.round(totalMansdag/malMansdag*100):0):(malTimmar>0?Math.round(totalTimmar/malTimmar*100):0);
    const snittpMalPct=malSnitt>0?Math.round(snittpMansdag/malSnitt*100):0;
    const secondLabel=useMansdag?'Mansdagar':'Timmar';
    const secondUtfall=useMansdag?totalMansdag:fmt2(totalTimmar);
    const secondMal=useMansdag?malMansdag:fmt2(malTimmar);
    const snittLabel=useMansdag?'Snitt per mansdag':'Snitt per timme';

    const badgeHtml=!projHasMal?`<span class="compare-badge badge-neutral">M√•l saknas</span>`:`<span class="compare-badge ${prodPct>=100?'badge-green':'badge-neutral'}">${prodPct}% av m√•l</span>`;

    const prodMetric=!projHasMal
      ?`<div class="compare-metric"><div class="compare-metric-label">Produkter <span>${totalProd}</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>`
      :`<div class="compare-metric"><div class="compare-metric-label">Produkter <span>${totalProd} / ${malProd}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${Math.min(prodPct,100)}%;background:${barColor(prodPct)}"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">${prodPct}% av m√•l</div></div>`;

    const hasSecondMal=useMansdag?malMansdag>0:malTimmar>0;
    const secondMetric=!hasSecondMal
      ?`<div class="compare-metric"><div class="compare-metric-label">${secondLabel} <span>${secondUtfall}</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>`
      :`<div class="compare-metric"><div class="compare-metric-label">${secondLabel} <span>${secondUtfall} / ${secondMal}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${Math.min(secondPct,100)}%;background:${barColor(secondPct)}"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">${secondPct}% av m√•l</div></div>`;

    const snittMetric=malSnitt<=0
      ?`<div class="compare-metric"><div class="compare-metric-label">${snittLabel} <span>${snittpMansdag}</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas ¬∑ ${avgSellers} s√§ljare/dag</div></div>`
      :`<div class="compare-metric"><div class="compare-metric-label">${snittLabel} <span>${snittpMansdag} / ${malSnitt}</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:${Math.min(snittpMalPct,100)}%;background:${barColor(snittpMalPct)}"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">${snittpMalPct}% av m√•l ¬∑ ${avgSellers} s√§ljare/dag</div></div>`;

    // Sparkline
    const days=new Date(y,m+1,0).getDate();
    let sparkP=[],malP=[];
    for(let i=1;i<=days;i++){
      const d=new Date(y,m,i); if(d.getDay()===0||d.getDay()===6) continue;
      const dk=toDateKey(y,m,i), ur=normalizeRow(uData[dk]||{},'utfall');
      sparkP.push(fmt2(findVal(ur,'Produkt')??0));
      malP.push(getProjectMalProd(proj,mData[dk]||{}));
    }
    const maxVal=Math.max(...sparkP,...malP,1);
    const W=560,H=44,n=sparkP.length;
    const px=i=>n>1?(i/(n-1))*W:W/2;
    const py=v=>H-(v/maxVal)*(H-4)-2;
    const malPath=malP.map((v,i)=>`${i===0?'M':'L'}${px(i).toFixed(1)},${py(v).toFixed(1)}`).join(' ');
    const utfPath=sparkP.map((v,i)=>`${i===0?'M':'L'}${px(i).toFixed(1)},${py(v).toFixed(1)}`).join(' ');
    const lineColor=prodPct>=100?'#2d8a4e':'#f97c5a';

    const sparkHtml=projHasMal?`<div class="sparkline"><div class="sparkline-label">Daglig produkt ‚Äì utfall vs m√•l</div><svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" style="overflow:visible"><path d="${malPath}" fill="none" stroke="${MAL_COLOR}" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/><path d="${utfPath}" fill="none" stroke="${lineColor}" stroke-width="2"/></svg><div style="display:flex;gap:12px;margin-top:5px;font-size:10px;color:#999;"><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:2px;background:${lineColor};border-radius:2px"></span>Utfall</span><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:0;border-top:2px dashed ${MAL_COLOR}"></span>M√•l</span></div></div>`:`<div class="sparkline"><div class="sparkline-label">Daglig produkt</div><svg width="100%" height="${H}" viewBox="0 0 ${W} ${H}" preserveAspectRatio="none" style="overflow:visible"><path d="${utfPath}" fill="none" stroke="#f97c5a" stroke-width="2"/></svg></div>`;

    return `<div class="compare-card" onclick="switchToDaily('${proj}')">
      <div class="compare-card-header"><span class="compare-card-title">${name}</span>${badgeHtml}</div>
      ${prodMetric}${secondMetric}${snittMetric}${sparkHtml}
    </div>`;
  }).join('');

  document.getElementById('overviewGrid').innerHTML=cards;
}

// === DAILY VIEW ===
function setDailyGroupFilter(g,el){
  dailyGroup=g;
  document.querySelectorAll('#dailyGroupFilter .filter-pill').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  const projs=g==='d2d'?GROUP_D2D:GROUP_TM;
  dailyProject=projs[0];
  buildProjectChips();
  renderDaily();
}

function buildProjectChips(){
  const projs=dailyGroup==='d2d'?GROUP_D2D:GROUP_TM;
  const sel=document.getElementById('dailyProjectSelector');
  sel.innerHTML=projs.map(p=>`<button class="proj-chip ${p===dailyProject?'active':''}" onclick="selectDailyProject('${p}',this)">${PROJECT_META[p]?.name||p}</button>`).join('');
}

function selectDailyProject(p,el){
  dailyProject=p;
  document.querySelectorAll('.proj-chip').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  renderDaily();
}

function setDailyView(v,el){
  dailyView=v;
  document.querySelectorAll('.view-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  renderDaily();
}

function renderDaily(){
  const m=getMonth(),y=getYear();
  const days=new Date(y,m+1,0).getDate();
  const cols=dailyView==='compact'?COMPACT_COLS:(PROJECT_COLS[dailyProject]||COMPACT_COLS);
  const {uData,mData}=getProjectData(dailyProject);
  const e=`<span class="empty-cell">‚Äî</span>`;

  document.getElementById('tableHead').innerHTML='<tr>'+cols.map(c=>`<th class="${c.goalKey?'goal-col':''}">${c.label}</th>`).join('')+'</tr>';

  let lastDataDay=0;
  for(let i=1;i<=days;i++){
    const dk=toDateKey(y,m,i), uRow=uData[dk]||{};
    const hasProd=findVal(uRow,'Produkt')??findVal(uRow,'produkt')??null;
    const hasSaljare=findVal(uRow,'Antal Mansdagar')??findVal(uRow,'Antal S√§ljare')??null;
    if((typeof hasProd==='number'&&hasProd>0)||(typeof hasSaljare==='number'&&hasSaljare>0)) lastDataDay=i;
  }

  let rows='';
  for(let i=1;i<=days;i++){
    const d=new Date(y,m,i), dayName=DAYS_SV[d.getDay()], weekend=isWeekend(d);
    const dateKey=toDateKey(y,m,i), uRow=uData[dateKey]||{}, mRow=mData[dateKey]||{};
    const hasUtfall=Object.keys(uRow).length>0, hasMal=Object.keys(mRow).length>0;
    const malSaljare=findVal(mRow,'M√•l s√§ljare')||findVal(mRow,'M√•l mansdagar')||0;
    const malTimmar=findVal(mRow,'M√•l timmar')||0;
    const isNonWorkingDay=hasMal&&malSaljare===0&&malTimmar===0;
    const dateStr=`${i} ${MONTHS_SV[m].substring(0,3).toLowerCase()}`;
    const isLastData=i===lastDataDay;
    const cls=isLastData?'last-data':(weekend||isNonWorkingDay)?'weekend':'';
    const dayLabel=isLastData?`<span class="day-badge">senast</span>${dayName}`:dayName;

    const cells=cols.map((c,idx)=>{
      if(idx===0) return `<td>${dayLabel}</td>`;
      if(idx===1) return `<td>${dateStr}</td>`;
      if(weekend||isNonWorkingDay) return `<td>${e}</td>`;
      if(c.goalKey){
        const gv=hasMal?resolveDynGoal(c.goalKey,mRow):null;
        return `<td class="goal goal-col">${typeof gv==='number'?fmt2(gv):'‚Äî'}</td>`;
      }
      if(c.key){
        const isSnitt=c.key.toLowerCase()==='snitt';
        const isProd=c.key==='Produkt';
        const isSaljare=c.key==='__utfall_saljare__';
        let uv;
        if(isSnitt) uv=hasUtfall?calcSnitt(dailyProject,uRow):null;
        else if(isProd&&dailyView==='compact') uv=hasUtfall?getCompactProd(dailyProject,uRow):null;
        else if(isSaljare) uv=hasUtfall?(findVal(uRow,'Antal Mansdagar')??findVal(uRow,'Antal S√§ljare')??null):null;
        else uv=hasUtfall?findVal(uRow,c.key):null;
        const gk=findGoalKey(cols,c.key);
        const gvRaw=hasMal&&gk?resolveDynGoal(gk,mRow):null;
        const gv=typeof gvRaw==='number'?fmt2(gvRaw):gvRaw;
        if(uv!==null&&uv!==''){
          let cls2='';
          if(gv!==null&&typeof uv==='number'&&typeof gv==='number') cls2=uv>=gv?'above':'below';
          return `<td${cls2?' class="'+cls2+'"':''}>${fmt2(uv)}</td>`;
        }
        return `<td>‚Äî</td>`;
      }
      return `<td>‚Äî</td>`;
    }).join('');
    rows+=`<tr class="${cls}">${cells}</tr>`;
  }

  // Summary row
  const summaryCells=cols.map((c,idx)=>{
    if(idx===0) return `<td>Summerat</td>`;
    if(idx===1) return `<td></td>`;
    if(c.goalKey){
      const isSnittGoal=c.goalKey.toLowerCase().includes('snitt');
      if(isSnittGoal){
        let sum=0,count=0;
        Object.values(mData).forEach(r=>{const v=resolveDynGoal(c.goalKey,r);if(typeof v==='number'&&v>0){sum+=v;count++;}});
        return `<td class="goal goal-col">${count>0?fmt2(sum/count):'‚Äî'}</td>`;
      }
      let sum=0;
      Object.values(mData).forEach(r=>{const v=resolveDynGoal(c.goalKey,r);if(typeof v==='number') sum+=v;});
      return `<td class="goal goal-col">${sum>0?fmt2(sum):'‚Äî'}</td>`;
    }
    if(c.key){
      if(c.key.toLowerCase()==='snitt'){
        const allR=Object.values(uData);
        const totalP=allR.reduce((s,r)=>{const v=findVal(r,'Produkt')??findVal(r,'produkt')??0;return s+(typeof v==='number'?v:0);},0);
        if(SNITT_PER_TIMMAR.has(dailyProject)){
          const totalT=allR.reduce((s,r)=>{const v=findVal(r,'Timmar')??findVal(r,'timmar')??0;return s+(typeof v==='number'?v:0);},0);
          return `<td>${totalT>0?fmt2(totalP/totalT):'‚Äî'}</td>`;
        } else {
          const totalS=allR.reduce((s,r)=>{const v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
          return `<td>${totalS>0?fmt2(totalP/totalS):'‚Äî'}</td>`;
        }
      }
      if(c.key==='__utfall_saljare__'){
        let sum=0;
        Object.values(uData).forEach(r=>{const v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;if(typeof v==='number') sum+=v;});
        return `<td>${sum>0?fmt2(sum):'‚Äî'}</td>`;
      }
      let sum=0;
      Object.values(uData).forEach(r=>{const v=findVal(r,c.key);if(typeof v==='number') sum+=v;});
      return `<td>${sum>0?fmt2(sum):'‚Äî'}</td>`;
    }
    return `<td>‚Äî</td>`;
  }).join('');
  rows+=`<tr class="summary-row">${summaryCells}</tr>`;

  document.getElementById('tableBody').innerHTML=rows;
  updateStatCards(uData,mData);
}

function updateStatCards(uData,mData){
  const uRows=Object.values(uData), mRows=Object.values(mData);
  const getProd=r=>findVal(r,'Produkt')??findVal(r,'produkt')??null;
  const getMalProd=r=>{
    const p=dailyProject;
    if(p==='mobil'||p==='fmc'){const h=findVal(r,'M√•l Huvudabb')??0,ea=findVal(r,'M√•l EA')??0;return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0)||null;}
    if(p==='vip-leads'){const bb=findVal(r,'M√•l BB')??0,mbh=findVal(r,'M√•l MBH')??0;return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0)||null;}
    if(p==='retention'||p==='mbh'){const v=findVal(r,'M√•l BB');return typeof v==='number'?v:null;}
    for(const k of ['M√•l S√§lj','M√•l produkt','M√•l Produkt','M√•l s√§lj']){const v=findVal(r,k);if(typeof v==='number') return v;}
    return null;
  };
  const totalProd=uRows.reduce((s,r)=>{const v=getProd(r);return s+(typeof v==='number'?v:0);},0);
  const malProd=mRows.reduce((s,r)=>{const v=getMalProd(r);return s+(typeof v==='number'?v:0);},0);
  const totalHours=uRows.reduce((s,r)=>{const v=findVal(r,'timmar')??findVal(r,'Utfall Timmar')??findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
  const workDays=uRows.filter(r=>{const v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return typeof v==='number'&&v>0;}).length;
  const totalSellers=uRows.reduce((s,r)=>{const v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return s+(typeof v==='number'?v:0);},0);

  const avgProd=workDays>0?fmt2(totalProd/workDays):0;
  const malAvgProd=(()=>{let s=0,c=0;mRows.forEach(r=>{const v=getMalProd(r);if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();
  const avgPerHour=totalHours>0?fmt2(totalProd/totalHours):0;
  const malAvgPerHour=(()=>{let s=0,c=0;mRows.forEach(r=>{const v=findVal(r,'M√•l snitt')??findVal(r,'M√•l snitt per mansdag')??null;if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();
  const avgSellers=workDays>0?fmt2(totalSellers/workDays):0;
  const malAvgSellers=(()=>{let s=0,c=0;mRows.forEach(r=>{const v=findVal(r,'M√•l s√§ljare')??findVal(r,'M√•l mansdagar')??null;if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();

  const setPct=(vEl,mEl,bEl,val,mal,suf='')=>{
    document.getElementById(vEl).textContent=val>0?(fmt2(val)+suf):'‚Äî';
    document.getElementById(mEl).textContent=`M√•l: ${mal>0?(fmt2(mal)+suf):'‚Äî'}`;
    const b=document.getElementById(bEl);
    if(val>0&&mal>0){const pct=Math.round(val/mal*100);b.textContent=`${pct}% av m√•l`;b.className='stat-badge '+(pct>=100?'badge-green':'badge-red');}
    else{b.textContent='Ingen data';b.className='stat-badge badge-neutral';}
  };
  setPct('sc-prod','sc-prod-meta','sc-prod-badge',totalProd,malProd);
  setPct('sc-avg','sc-avg-meta','sc-avg-badge',avgProd,malAvgProd);
  setPct('sc-phtimme','sc-phtimme-meta','sc-phtimme-badge',avgPerHour,malAvgPerHour);
  setPct('sc-sellers','sc-sellers-meta','sc-sellers-badge',avgSellers,malAvgSellers);

  // Takt
  const taktEl=document.getElementById('sc-prod-takt');
  if(taktEl){
    const getMalSaljare=r=>findVal(r,'M√•l s√§ljare')??findVal(r,'M√•l mansdagar')??null;
    const malDaysTotal=mRows.filter(r=>{const v=getMalSaljare(r);return typeof v==='number'&&v>0;}).length;
    if(workDays>0&&malProd>0&&malDaysTotal>0){
      const expected=malProd*(workDays/malDaysTotal), diff=totalProd-expected, diffPct=Math.round((diff/expected)*100);
      taktEl.innerHTML=diff>=0?`<span style="color:#2d8a4e;font-weight:600;">‚ñ≤ On track</span> <span style="color:#666;">(+${Math.round(diff)} / +${diffPct}%)</span>`:`<span style="color:#c0392b;font-weight:600;">‚ñº Off track</span> <span style="color:#666;">(${Math.round(diff)} / ${diffPct}%)</span>`;
    } else taktEl.innerHTML='';
  }
}

// === DATA LOADING ===
function convertJsonToStore(raw,store){
  const sheetToProject={};
  for(const [p,meta] of Object.entries(PROJECT_META)) sheetToProject[meta.sheet]=p;
  const normalize=s=>s.toLowerCase().replace(/^\d+[\.\d]*\s*/,'').replace(/\./g,'').trim();
  for(const [sheetName,dateRows] of Object.entries(raw)){
    let proj=sheetToProject[sheetName];
    if(!proj){ const ns=normalize(sheetName); for(const [sheet,p] of Object.entries(sheetToProject)){if(normalize(sheet)===ns){proj=p;break;}} }
    if(!proj) continue;
    for(const [dateKey,row] of Object.entries(dateRows)){
      const d=new Date(dateKey); if(isNaN(d)) continue;
      const key=storeKey(proj,d.getFullYear(),d.getMonth());
      if(!store[key]) store[key]={};
      store[key][dateKey]=row;
    }
  }
}

async function loadData(){
  try{
    const [uR,mR,sR]=await Promise.all([
      fetch('data/utfall.json',{cache:'no-store'}),
      fetch('data/mal.json',{cache:'no-store'}),
      fetch('data/last_synced.json',{cache:'no-store'})
    ]);
    if(uR.ok){convertJsonToStore(await uR.json(),utfallData);}
    if(mR.ok){convertJsonToStore(await mR.json(),malData);}
    if(sR.ok){const s=await sR.json();const el=document.getElementById('lastSynced');if(el&&s.last_synced) el.textContent='Senast synkad: '+s.last_synced;}
  }catch(e){console.warn('Kunde inte ladda data:',e);}
  renderCurrent();
}

// === IMPORT ===
function openModal(id){document.getElementById(id).classList.add('visible');}
function closeModal(id){document.getElementById(id).classList.remove('visible');}
function handleImport(type){
  const pwId=type==='utfall'?'utfallPw':'malPw', errId=type==='utfall'?'utfallPwError':'malPwError';
  const fileId=type==='utfall'?'utfallFile':'malFile', modalId=type==='utfall'?'utfallModal':'malModal';
  const successId=type==='utfall'?'utfallSuccess':'malSuccess';
  const pw=document.getElementById(pwId).value;
  if(pw!=='ViaProdPlan2040#!'){document.getElementById(errId).classList.add('visible');return;}
  document.getElementById(errId).classList.remove('visible');
  const file=document.getElementById(fileId).files[0];
  if(!file){alert('V√§lj en Excel-fil.');return;}
  const reader=new FileReader();
  reader.onload=ev=>{
    try{
      const wb=XLSX.read(ev.target.result,{type:'array',cellDates:true});
      parseWorkbook(wb,type);
      closeModal(modalId);
      const el=document.getElementById(successId);el.classList.add('visible');setTimeout(()=>el.classList.remove('visible'),3000);
      renderCurrent();
    }catch(err){alert('Kunde inte l√§sa filen: '+err.message);}
  };
  reader.readAsArrayBuffer(file);
}

function parseWorkbook(wb,type){
  const store=type==='utfall'?utfallData:malData;
  for(const [proj,meta] of Object.entries(PROJECT_META)){
    let sheet=wb.Sheets[meta.sheet];
    if(!sheet){const found=wb.SheetNames.find(s=>s.toLowerCase().includes(meta.sheet.toLowerCase().replace(/^\d+[\.\d]*\s*/,'')));if(found) sheet=wb.Sheets[found];}
    if(!sheet) continue;
    const rows=XLSX.utils.sheet_to_json(sheet,{defval:''});
    if(!rows.length) continue;
    let fileMonth=null,fileYear=null;
    for(const row of rows){
      let dv=row['DATUM']||row['Datum']||row['datum'];if(!dv) continue;
      let d;
      if(dv instanceof Date) d=dv;
      else if(typeof dv==='string'&&dv.includes('-')) d=new Date(dv);
      else if(typeof dv==='number') d=new Date(Math.round((dv-25569)*86400*1000));
      if(!d||isNaN(d)) continue;
      fileMonth=d.getMonth();fileYear=d.getFullYear();break;
    }
    if(fileMonth===null) continue;
    const key=storeKey(proj,fileYear,fileMonth);
    store[key]={};
    rows.forEach(row=>{
      let dv=row['DATUM']||row['Datum']||row['datum'];if(!dv) return;
      let d;
      if(dv instanceof Date) d=dv;
      else if(typeof dv==='string'&&dv.includes('-')) d=new Date(dv);
      else if(typeof dv==='number') d=new Date(Math.round((dv-25569)*86400*1000));
      if(!d||isNaN(d)) return;
      if(d.getMonth()!==fileMonth||d.getFullYear()!==fileYear) return;
      const dk=toDateKey(d.getFullYear(),d.getMonth(),d.getDate());
      store[key][dk]=row;
    });
  }
}

// === INIT ===
buildProjectChips();
buildOverviewProjectChips();
loadData();
</script>
</body>
</html>
