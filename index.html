<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIASALES Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f2f0; min-height: 100vh; color: #1a1a1a; font-size: 13px; }

  header {
    background: #fff; border-bottom: 1px solid #ebebeb;
    padding: 0 32px; height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, #f97c5a, #e8503a);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 14px;
  }
  .logo-text { font-weight: 600; font-size: 15px; letter-spacing: 0.5px; }

  .header-right { display: flex; align-items: center; gap: 10px; }

  .main-nav {
    display: flex; align-items: center; gap: 0;
    background: #f0f0ee; border-radius: 10px; padding: 3px; margin-left: 20px;
  }
  .main-nav-tab {
    padding: 7px 18px; border-radius: 8px; font-size: 13px; cursor: pointer;
    color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none;
    white-space: nowrap;
  }
  .main-nav-tab.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
  .main-nav-tab:hover:not(.active) { color: #333; }

  .btn {
    display: flex; align-items: center; gap: 6px;
    padding: 7px 14px; border-radius: 8px;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: background 0.15s; white-space: nowrap; border: 1px solid #ebebeb; background: #fff; color: #555;
  }
  .btn:hover { background: #f7f7f5; }

  .filter-bar {
    display: flex; align-items: center; gap: 10px; padding: 12px 24px;
    background: #fff; border-bottom: 1px solid #ebebeb;
    flex-wrap: wrap;
  }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-label { font-size: 11px; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-pills { display: flex; gap: 4px; background: #f0f0ee; border-radius: 8px; padding: 3px; }
  .filter-pill {
    padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer;
    color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none;
  }
  .filter-pill.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
  .filter-pill:hover:not(.active) { color: #333; }

  select {
    border: 1.5px solid #aaa; border-radius: 8px; padding: 6px 28px 6px 10px;
    font-size: 13px; font-weight: 600; background: #fff; color: #1a1a1a;
    cursor: pointer; outline: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23999'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
  }
  select:focus { border-color: #f97c5a; }

  .nav-btn {
    width: 28px; height: 28px; border: 1.5px solid #aaa; border-radius: 6px;
    background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: #333; font-weight: 600; transition: all 0.15s;
  }
  .nav-btn:hover { background: #f7f7f5; }

  main { padding: 0; min-height: calc(100vh - 56px); }
  .page-section { padding: 20px 24px; }
  .page-title { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
  .page-sub { font-size: 11px; color: #999; margin-bottom: 14px; }

  .compare-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }
  .compare-card {
    background: #fff; border: 1px solid #ebebeb; border-radius: 12px; padding: 18px;
    cursor: pointer; transition: box-shadow 0.15s, border-color 0.15s;
  }
  .compare-card:hover { border-color: #f97c5a; box-shadow: 0 2px 12px rgba(249,124,90,0.1); }
  .compare-card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
  .compare-card-title { font-size: 14px; font-weight: 600; }
  .compare-badge { font-size: 12px; font-weight: 600; padding: 3px 10px; border-radius: 20px; }
  .badge-green { background: #e8f7ee; color: #2d8a4e; }
  .badge-red { background: #fdecea; color: #c0392b; }
  .badge-neutral { background: #f0f0f0; color: #666; }
  .compare-metric { margin-bottom: 12px; }
  .compare-metric-label { font-size: 11px; color: #1a1a1a; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; margin-bottom: 4px; display: flex; justify-content: space-between; }
  .compare-metric-label span { color: #1a1a1a; font-weight: 600; font-size: 12px; text-transform: none; letter-spacing: 0; }
  .progress-bar-bg { height: 6px; background: #f0f0ee; border-radius: 10px; overflow: hidden; }
  .progress-bar-fill { height: 100%; border-radius: 10px; transition: width 0.4s ease; }
  .sparkline { margin-top: 14px; border-top: 1px solid #f0f0ee; padding-top: 10px; }
  .sparkline-label { font-size: 11px; color: #1a1a1a; margin-bottom: 6px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; }

  .stat-cards { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 16px; }
  .stat-card { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; padding: 10px 16px; }
  .stat-label { font-size: 10px; color: #1a1a1a; font-weight: 500; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
  .stat-value { font-size: 20px; font-weight: 600; }
  .stat-meta { font-size: 10px; color: #999; margin-top: 2px; }
  .stat-badge { display: inline-block; font-size: 10px; font-weight: 600; padding: 1px 6px; border-radius: 20px; margin-top: 4px; }

  .table-wrap { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; overflow: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead { background: #fafafa; }
  th { padding: 6px 10px; text-align: center; font-size: 10px; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #d0650a; white-space: nowrap; background: #f97c5a; }
  th.goal-col { background: #e8503a; }
  td { padding: 5px 10px; border-bottom: 1px solid #f5f5f5; font-size: 12px; color: #333; white-space: nowrap; text-align: center; }
  td.goal-col { background: #fafafa; }
  tr:last-child td { border-bottom: none; }
  tr.weekend td { background: #efefed; color: #bbb; }
  tr.weekend td.goal-col { background: #e8e8e6; }
  tr.last-data td, tr.last-data td.goal-col { background: #fff0eb !important; }
  tr.last-data td:first-child { border-left: 3px solid #f97c5a; }
  td.goal { color: #1a1a1a; font-size: 12px; font-weight: 500; }
  td.above { color: #2d8a4e; font-weight: 600; }
  td.below { color: #c0392b; font-weight: 600; }
  .day-badge { display: inline-block; font-size: 9px; font-weight: 600; color: #f97c5a; background: #fff5f3; border-radius: 3px; padding: 1px 5px; margin-right: 4px; }
  tr.summary-row td { font-weight: 700; color: #1a1a1a; border-top: 2px solid #e8503a; background: #fde0d8; font-size: 12px; }
  tr.summary-row td.goal-col { background: #f9cfc6; }
  .empty-cell { color: #ddd; }

  .project-selector { display: flex; gap: 6px; flex-wrap: wrap; }
  .proj-chip {
    padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer;
    border: 1.5px solid #aaa; background: #fff; color: #333; font-weight: 600;
    transition: all 0.15s;
  }
  .proj-chip.active { background: #f97c5a; color: #fff; border-color: #f97c5a; }
  .proj-chip:hover:not(.active) { border-color: #f97c5a; color: #e8503a; }

  .view-tabs { display: flex; gap: 4px; background: #f0f0ee; border-radius: 8px; padding: 3px; }
  .view-tab { padding: 5px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none; }
  .view-tab.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }

  .summary-card {
    background: #fff; border: 1px solid #ebebeb; border-radius: 14px; padding: 22px 28px;
    display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 20px; align-items: start;
  }
  .summary-card .sc-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #999; margin-bottom: 4px; }
  .summary-card .sc-value { font-size: 22px; font-weight: 700; color: #1a1a1a; }
  .summary-card .sc-meta { font-size: 11px; color: #999; margin-top: 2px; }
  .summary-card .sc-badge { display: inline-block; font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 20px; margin-top: 4px; }
  .summary-card .sc-spark { grid-column: 1 / -1; border-top: 1px solid #f0f0ee; padding-top: 14px; margin-top: 4px; }
  .summary-card .sc-spark-label { font-size: 11px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.4px; color: #1a1a1a; margin-bottom: 6px; }

  .toolbar-row {
    display: flex; align-items: center; gap: 10px; flex-wrap: wrap; margin-bottom: 12px;
  }

  .month-bar {
    background: #f0f0ee; border-bottom: 1px solid #ebebeb;
  }

  @media (max-width: 768px) {
    .summary-card { grid-template-columns: repeat(2, 1fr); gap: 14px; padding: 16px; }
    .summary-card .sc-value { font-size: 18px; }
    .summary-card .sc-spark { grid-column: 1 / -1; }
    header { padding: 0 12px; height: 48px; }
    .logo-text { font-size: 13px; }
    .logo-icon { width: 28px; height: 28px; font-size: 12px; }
    .main-nav { margin-left: 10px; }
    .main-nav-tab { padding: 5px 12px; font-size: 12px; }
    .header-right { gap: 6px; }
    .header-right > div:not(.main-nav) { display: none; }
    .filter-bar { padding: 10px 12px; gap: 8px; }
    .page-section { padding: 14px 12px; }
    .page-title { font-size: 15px; }
    .compare-grid { grid-template-columns: 1fr; gap: 10px; }
    .stat-cards { grid-template-columns: repeat(2, 1fr); gap: 6px; }
    .stat-card { padding: 8px 12px; }
    .stat-value { font-size: 16px; }
    .project-selector { gap: 4px; }
    .proj-chip { padding: 4px 10px; font-size: 11px; }
    th { font-size: 9px; padding: 5px 6px; }
    td { font-size: 11px; padding: 4px 6px; }
  }
</style>
</head>
<body>

<header>
  <div class="logo" style="display:flex;align-items:center;">
    <div class="logo-icon">V</div>
    <span class="logo-text">VIASALES</span>
    <div class="main-nav" id="mainNav">
      <button class="main-nav-tab active" onclick="switchPage('overview')">üìä √ñversikt</button>
      <button class="main-nav-tab" onclick="switchPage('daily')">üìÖ Daglig uppf√∂ljning</button>
    </div>
  </div>
  <div class="header-right">
    <div style="display:flex;align-items:center;gap:6px;font-size:12px;color:#666;">
      <svg viewBox="0 0 20 20" fill="currentColor" width="13" height="13"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/></svg>
      <span id="lastSynced">Senast synkad: ‚Äî</span>
    </div>
  </div>
</header>

<main>
  <!-- ======== OVERVIEW PAGE ======== -->
  <div id="overviewPage">
    <div class="filter-bar" style="flex-direction:column;align-items:stretch;gap:8px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div class="filter-group">
          <span class="filter-label">Visa:</span>
          <div class="filter-pills" id="overviewFilter">
            <button class="filter-pill active" onclick="setOverviewFilter('alla',this)">Alla</button>
            <button class="filter-pill" onclick="setOverviewFilter('d2d',this)">D2D</button>
            <button class="filter-pill" onclick="setOverviewFilter('tm',this)">TM</button>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div class="filter-group">
          <span class="filter-label">Projekt:</span>
          <div class="project-selector" id="overviewProjectSelector"></div>
        </div>
      </div>
    </div>
    <div class="filter-bar month-bar" style="border-top:none;">
      <div class="filter-group">
        <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
        <select id="monthSel" onchange="renderCurrent()">
          <option value="0">Januari</option><option value="1" selected>Februari</option>
          <option value="2">Mars</option><option value="3">April</option>
          <option value="4">Maj</option><option value="5">Juni</option>
          <option value="6">Juli</option><option value="7">Augusti</option>
          <option value="8">September</option><option value="9">Oktober</option>
          <option value="10">November</option><option value="11">December</option>
        </select>
        <select id="yearSel" onchange="renderCurrent()">
          <option value="2024">2024</option><option value="2025">2025</option>
          <option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
    </div>
    <div class="page-section">
      <div class="page-title">√ñversikt</div>
      <div class="page-sub" id="overviewSub">Februari 2026</div>
      <div id="overviewSummaryCard"></div>
      <div id="overviewGrid" class="compare-grid" style="margin-top:14px;"></div>
    </div>
  </div>

  <!-- ======== DAILY PAGE ======== -->
  <div id="dailyPage" style="display:none;">
    <div class="filter-bar" style="flex-direction:column;align-items:stretch;gap:8px;">
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div class="filter-group">
          <span class="filter-label">Filter:</span>
          <div class="filter-pills" id="dailyGroupFilter">
            <button class="filter-pill" onclick="setDailyGroupFilter('alla',this)">Alla</button>
            <button class="filter-pill active" onclick="setDailyGroupFilter('d2d',this)">D2D</button>
            <button class="filter-pill" onclick="setDailyGroupFilter('tm',this)">TM</button>
          </div>
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
        <div class="filter-group">
          <span class="filter-label">Projekt:</span>
          <div class="project-selector" id="dailyProjectSelector"></div>
        </div>
      </div>
    </div>
    <div class="filter-bar month-bar" style="border-top:none;">
      <div class="filter-group">
        <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
        <select id="monthSel2" onchange="syncMonthFrom(this);renderCurrent()">
          <option value="0">Januari</option><option value="1" selected>Februari</option>
          <option value="2">Mars</option><option value="3">April</option>
          <option value="4">Maj</option><option value="5">Juni</option>
          <option value="6">Juli</option><option value="7">Augusti</option>
          <option value="8">September</option><option value="9">Oktober</option>
          <option value="10">November</option><option value="11">December</option>
        </select>
        <select id="yearSel2" onchange="syncYearFrom(this);renderCurrent()">
          <option value="2024">2024</option><option value="2025">2025</option>
          <option value="2026" selected>2026</option><option value="2027">2027</option>
        </select>
        <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
      </div>
      <div class="view-tabs" id="dailyViewTabs">
        <button class="view-tab active" data-view="full" onclick="setDailyView('full',this)">Alla kolumner</button>
        <button class="view-tab" data-view="compact" onclick="setDailyView('compact',this)">Kompakt</button>
        <button class="view-tab" data-view="compare" style="display:none" onclick="setDailyView('compare',this)">J√§mf√∂relse</button>
      </div>
    </div>
    <div class="page-section" style="padding-top:14px;">
      <div class="stat-cards" id="dailyStatCards">
        <div class="stat-card">
          <div class="stat-label">Utfall produkter</div>
          <div class="stat-value" id="sc-prod">‚Äî</div>
          <div class="stat-meta" id="sc-prod-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-prod-badge">Ingen data</div>
          <div id="sc-prod-takt" style="font-size:11px;margin-top:4px;"></div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Snitt per dag</div>
          <div class="stat-value" id="sc-avg">‚Äî</div>
          <div class="stat-meta" id="sc-avg-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-avg-badge">Ingen data</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Snitt per timme</div>
          <div class="stat-value" id="sc-phtimme">‚Äî</div>
          <div class="stat-meta" id="sc-phtimme-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-phtimme-badge">Ingen data</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">S√§ljare per dag</div>
          <div class="stat-value" id="sc-sellers">‚Äî</div>
          <div class="stat-meta" id="sc-sellers-meta">M√•l: ‚Äî</div>
          <div class="stat-badge badge-neutral" id="sc-sellers-badge">Ingen data</div>
        </div>
      </div>
      <div class="table-wrap" id="tableWrap">
        <table><thead id="tableHead"></thead><tbody id="tableBody"></tbody></table>
      </div>
      <div id="dailyCompareWrap" style="display:none"></div>
    </div>
  </div>
</main>

<script>
const MONTHS_SV=['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September','Oktober','November','December'];
const DAYS_SV=['S√∂ndag','M√•ndag','Tisdag','Onsdag','Torsdag','Fredag','L√∂rdag'];
const GROUP_D2D=['telia-fm','villafiber','koax','lan'];
const GROUP_TM=['globalconnect','adressandring','vip-leads','retention','mbh','mobil','fmc'];
const ALL_PROJECTS=[...GROUP_D2D,...GROUP_TM];
const MANSDAG_PROJECTS=new Set(['telia-fm','villafiber','koax','lan','globalconnect']);
const SNITT_PER_TIMMAR=new Set(['adressandring','vip-leads','retention','mbh','mobil','fmc']);

const PROJECT_META={
  'telia-fm':{name:'Telia FM',sheet:'1.1. Telia D2D'},
  'villafiber':{name:'Villafiber',sheet:'1.3. Tele2 Villafiber'},
  'koax':{name:'Koax',sheet:'1.2. Tele2 Koax'},
  'lan':{name:'LAN',sheet:'1.4. LAN'},
  'globalconnect':{name:'GlobalConnect',sheet:'GlobalConnect'},
  'adressandring':{name:'Telia Adress√§ndring',sheet:'2.7. Telia Adress√§ndring'},
  'vip-leads':{name:'Telia VIP Leads',sheet:'2.6. Telia VIP Leads'},
  'retention':{name:'Telia Retention',sheet:'2.5. Telia Retention Leads'},
  'mbh':{name:'Telia MBH',sheet:'2.2. Telia MBH'},
  'mobil':{name:'Telia Mobil',sheet:'2.2. Telia Mobil'},
  'fmc':{name:'Telia FMC',sheet:'2.2.1. Telia FMC'}
};

let currentPage='overview';
let overviewFilter='alla';
let overviewProject=null;
let dailyGroup='d2d';
let dailyProject=new Set(['telia-fm']);
let dailyView='full';
let utfallData={};
let malData={};
let _dailyRef=null;

const COMPACT_COLS=[
  {label:'Dag'},{label:'Datum'},
  {label:'M√•l s√§ljare',goalKey:'__mal_saljare__'},{label:'Utfall s√§ljare',key:'__utfall_saljare__'},
  {label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},
  {label:'M√•l Produkt',goalKey:'__mal_prod__'},{label:'Utfall Produkt',key:'Produkt'}
];

const PROJECT_COLS={
  'telia-fm':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l S√§lj',goalKey:'M√•l S√§lj'},{label:'Utfall Produkter',key:'Produkt'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall Timmar',key:'Utfall Timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Premium',goalKey:'M√•l Premium'},{label:'Utfall Premium',key:'Streaming'},{label:'M√•l Mob',goalKey:'M√•l Mob'},{label:'Utfall Mob',key:'MOBIL'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'villafiber':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'koax':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'lan':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'M√•l Produkt',goalKey:'M√•l Produkt'},{label:'Utfall Produkt',key:'Produkt'},{label:'DTV',key:'TV'},{label:'BB',key:'Bredband'},{label:'MBB',key:'MBB'},{label:'Mobil',key:'Mobil'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'globalconnect':[{label:'Dag'},{label:'Datum'},{label:'M√•l mansdagar',goalKey:'M√•l mansdagar'},{label:'Utfall mansdagar',key:'Antal Mansdagar'},{label:'Utfall / densi',key:'Utfall / densi (Enligt orderfil)'},{label:'Utfall bygg / nytt',key:'Utfall bygg / nytt (Enligt orderfil)'},{label:'PTS24',key:'PTS24'},{label:'Utfall MDU:er',key:'Utfall MDU:er'},{label:'Utfall total',key:'Utfall total (Enligt orderfil)'},{label:'I S√§ljark',key:'I S√§ljarket'},{label:'Diff',key:'Diff Orderfil mot s√§ljark'},{label:'√Önger',key:'√Önger'},{label:'Bortfall',key:'Bortfall'},{label:'M√•l snitt/mansdag',goalKey:'M√•l snitt per mansdag'},{label:'Utfall snitt/mansdag',key:'snitt'}],
  'adressandring':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal S√§ljare'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l produkt',goalKey:'M√•l produkt'},{label:'Utfall Produkt',key:'produkt'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l Flytt BB',goalKey:'M√•l Flytt BB'},{label:'Utfall Flytt BB',key:'Flytt Bredband'},{label:'M√•l MBH',goalKey:'M√•l MBH'},{label:'Utfall MBH',key:'MBH'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'vip-leads':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal S√§ljare'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l MBH',goalKey:'M√•l MBH'},{label:'Utfall MBH',key:'MBH'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'retention':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l Nyteck TV',goalKey:'M√•l Nyteck TV'},{label:'Utfall Nyteck TV',key:'TV FL'},{label:'Utfall F√∂rl√§ngning TV',key:'TV BOX'},{label:'M√•l premium',goalKey:'M√•l premium'},{label:'Utfall premium',key:'Streaming'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'mbh':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'timmar'},{label:'M√•l BB',goalKey:'M√•l BB'},{label:'Utfall BB',key:'Bredband'},{label:'M√•l TV',goalKey:'M√•l TV'},{label:'Utfall TV',key:'TV'},{label:'M√•l Film',goalKey:'M√•l Film'},{label:'Utfall film',key:'Film'},{label:'M√•l Sport',goalKey:'M√•l Sport'},{label:'Utfall sport',key:'Sport'},{label:'M√•l Mobil',goalKey:'M√•l Mobil'},{label:'Utfall Mobil',key:'Mobil'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'mobil':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l Huvudabb',goalKey:'M√•l Huvudabb'},{label:'Utfall Huvudabb',key:'Mobil'},{label:'M√•l EA',goalKey:'M√•l EA'},{label:'Utfall EA',key:'EA'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}],
  'fmc':[{label:'Dag'},{label:'Datum'},{label:'M√•l s√§ljare',goalKey:'M√•l s√§ljare'},{label:'Utfall s√§ljare',key:'Antal Mansdagar'},{label:'M√•l timmar',goalKey:'M√•l timmar'},{label:'Utfall timmar',key:'Timmar'},{label:'M√•l Huvudabb',goalKey:'M√•l Huvudabb'},{label:'Utfall Huvudabb',key:'Mobil'},{label:'M√•l EA',goalKey:'M√•l EA'},{label:'Utfall EA',key:'EA'},{label:'M√•l snitt',goalKey:'M√•l snitt'},{label:'Utfall snitt',key:'snitt'}]
};

function getMonth(){ return parseInt(document.getElementById('monthSel').value); }
function getYear(){ return parseInt(document.getElementById('yearSel').value); }
function syncMonthFrom(sel){ document.getElementById('monthSel').value=sel.value; }
function syncYearFrom(sel){ document.getElementById('yearSel').value=sel.value; }
function changeMonth(dir){
  var m=getMonth()+dir, y=getYear();
  if(m<0){m=11;y--;} if(m>11){m=0;y++;}
  document.getElementById('monthSel').value=m;
  document.getElementById('yearSel').value=y;
  document.getElementById('monthSel2').value=m;
  document.getElementById('yearSel2').value=y;
  renderCurrent();
}
function toDateKey(y,m,d){ return y+'-'+String(m+1).padStart(2,'0')+'-'+String(d).padStart(2,'0'); }
function storeKey(proj,y,m){ return proj+'_'+y+'_'+m; }
function fmt2(v){ return typeof v==='number'?parseFloat(v.toFixed(2)):v; }
function isWeekend(d){ return d.getDay()===0||d.getDay()===6; }
function findVal(obj,key){
  if(!obj||!key) return null;
  var lk=key.toLowerCase();
  for(var k of Object.keys(obj)){ if(k.toLowerCase()===lk) return obj[k]; }
  return null;
}

function resolveDynGoal(goalKey,mRow){
  if(goalKey==='__mal_saljare__'){
    for(var k of ['M√•l s√§ljare','M√•l mansdagar']){ var v=findVal(mRow,k); if(typeof v==='number') return v; }
    return null;
  }
  if(goalKey==='__mal_prod__'){
    var p=_dailyRef||[...dailyProject][0];
    if(p==='mobil'||p==='fmc'){ var h=findVal(mRow,'M√•l Huvudabb')??0, ea=findVal(mRow,'M√•l EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0)||null; }
    if(p==='vip-leads'){ var bb=findVal(mRow,'M√•l BB')??0, mbh=findVal(mRow,'M√•l MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0)||null; }
    if(p==='retention'||p==='mbh'){ var v2=findVal(mRow,'M√•l BB'); return typeof v2==='number'?v2:null; }
    for(var k2 of ['M√•l S√§lj','M√•l Produkt','M√•l produkt','M√•l s√§lj']){ var v3=findVal(mRow,k2); if(typeof v3==='number') return v3; }
    return null;
  }
  return findVal(mRow,goalKey);
}

function getProjectMalProd(proj,mRow){
  var nr=normalizeRow(mRow,'mal');
  if(proj==='mobil'||proj==='fmc'){ var h=findVal(nr,'M√•l Huvudabb')??0, ea=findVal(nr,'M√•l EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0); }
  if(proj==='vip-leads'){ var bb=findVal(nr,'M√•l BB')??0, mbh=findVal(nr,'M√•l MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0); }
  if(proj==='retention'||proj==='mbh'){ var v=findVal(nr,'M√•l BB'); return typeof v==='number'?v:0; }
  var v2=findVal(nr,'M√•l S√§lj'); return typeof v2==='number'?v2:0;
}

function normalizeRow(row,type){
  var out={};
  var km=type==='utfall'?{'produkt':'Produkt','timmar':'Timmar','utfall timmar':'Timmar','antal s√§ljare':'Antal Mansdagar'}:{'m√•l mansdagar':'M√•l s√§ljare','m√•l produkt':'M√•l S√§lj','m√•l s√§lj':'M√•l S√§lj','m√•l snitt per mansdag':'M√•l snitt'};
  for(var [k,v] of Object.entries(row)){
    var mapped=km[k.toLowerCase()]; var tk=mapped||k;
    if(out[tk]!==undefined){ if(typeof v==='number'&&typeof out[tk]==='number') out[tk]+=v; }
    else out[tk]=v;
  }
  return out;
}

function calcSnitt(proj,uRow){
  var prod=findVal(uRow,'Produkt')??findVal(uRow,'produkt')??null;
  if(typeof prod!=='number') return null;
  if(SNITT_PER_TIMMAR.has(proj)){
    var t=findVal(uRow,'Timmar')??findVal(uRow,'timmar')??null;
    return (typeof t==='number'&&t>0)?fmt2(prod/t):null;
  } else {
    var s=findVal(uRow,'Antal Mansdagar')??findVal(uRow,'Antal S√§ljare')??null;
    return (typeof s==='number'&&s>0)?fmt2(prod/s):null;
  }
}

function findGoalKey(cols,utfallKey){
  for(var i=0;i<cols.length;i++){
    if(cols[i].key&&cols[i].key.toLowerCase()===utfallKey.toLowerCase()){
      if(i>0&&cols[i-1].goalKey) return cols[i-1].goalKey;
    }
  }
  return null;
}

function getCompactProd(proj,row){
  if(proj==='vip-leads'){ var bb=findVal(row,'Bredband')??0, mbh=findVal(row,'MBH')??0; return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0); }
  if(proj==='retention'||proj==='mbh') return findVal(row,'Bredband')??findVal(row,'BB')??null;
  if(proj==='mobil'||proj==='fmc'){ var h=findVal(row,'Mobil')??0, ea=findVal(row,'EA')??0; return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0); }
  return findVal(row,'Produkt')??findVal(row,'produkt')??null;
}

function generateDummyData(proj,m,y){
  var days=new Date(y,m+1,0).getDate();
  var uData={},mData={};
  var seeds={'telia-fm':{s:8,t:60,p:18},'villafiber':{s:5,t:38,p:10},'koax':{s:4,t:30,p:8},'lan':{s:3,t:22,p:6},'globalconnect':{s:6,t:45,p:12},'adressandring':{s:7,t:52,p:15},'vip-leads':{s:5,t:40,p:11},'retention':{s:6,t:44,p:13},'mbh':{s:4,t:32,p:9},'mobil':{s:5,t:38,p:10},'fmc':{s:3,t:24,p:7}};
  var seed=seeds[proj]||{s:5,t:40,p:10};
  for(var i=1;i<=days;i++){
    var d=new Date(y,m,i); if(d.getDay()===0||d.getDay()===6) continue;
    var dk=toDateKey(y,m,i), v=0.7+Math.random()*0.6;
    uData[dk]={'Antal Mansdagar':seed.s,'timmar':Math.round(seed.t*v),'Produkt':Math.round(seed.p*v),'snitt':parseFloat((seed.p*v/seed.s).toFixed(2))};
    mData[dk]={'M√•l s√§ljare':seed.s,'M√•l timmar':seed.t,'M√•l S√§lj':seed.p,'M√•l snitt':parseFloat((seed.p/seed.s).toFixed(2))};
  }
  return {uData:uData,mData:mData};
}

function getProjectData(proj){
  var m=getMonth(),y=getYear();
  var u=utfallData[storeKey(proj,y,m)]||{}, ml=malData[storeKey(proj,y,m)]||{};
  if(!Object.keys(u).length&&!Object.keys(ml).length){ var d=generateDummyData(proj,m,y); u=d.uData; ml=d.mData; }
  return {uData:u,mData:ml};
}

function switchPage(page){
  currentPage=page;
  document.querySelectorAll('.main-nav-tab').forEach(function(t){t.classList.remove('active');});
  document.querySelectorAll('.main-nav-tab').forEach(function(t){ if((page==='overview'&&t.textContent.indexOf('√ñversikt')>=0)||(page==='daily'&&t.textContent.indexOf('Daglig')>=0)) t.classList.add('active'); });
  document.getElementById('overviewPage').style.display=page==='overview'?'':'none';
  document.getElementById('dailyPage').style.display=page==='daily'?'':'none';
  renderCurrent();
}

function switchToDaily(proj){
  var group=GROUP_D2D.indexOf(proj)>=0?'d2d':'tm';
  dailyGroup=group;
  dailyProject=new Set([proj]);
  document.querySelectorAll('#dailyGroupFilter .filter-pill').forEach(function(p){ p.classList.toggle('active',p.textContent.toLowerCase()===group); });
  buildProjectChips();
  updateDailyTabs();
  switchPage('daily');
}

function renderCurrent(){
  if(currentPage==='overview') renderOverview();
  else renderDaily();
}

function setOverviewFilter(f,el){
  overviewFilter=f;
  overviewProject=null;
  document.querySelectorAll('#overviewFilter .filter-pill').forEach(function(p){p.classList.remove('active');});
  el.classList.add('active');
  buildOverviewProjectChips();
  renderOverview();
}

function buildOverviewProjectChips(){
  var projs=overviewFilter==='d2d'?GROUP_D2D:overviewFilter==='tm'?GROUP_TM:ALL_PROJECTS;
  var sel=document.getElementById('overviewProjectSelector');
  var isAll=overviewProject===null;
  var html='<button class="proj-chip '+(isAll?'active':'')+'" onclick="selectOverviewProject(\'alla\',this,event)">Alla</button>';
  projs.forEach(function(p){
    var active=overviewProject instanceof Set&&overviewProject.has(p);
    html+='<button class="proj-chip '+(active?'active':'')+'" onclick="selectOverviewProject(\''+p+'\',this,event)">'+PROJECT_META[p].name+'</button>';
  });
  sel.innerHTML=html;
}

function selectOverviewProject(p,el,ev){
  if(p==='alla'){
    overviewProject=null;
  } else if(ev&&(ev.ctrlKey||ev.metaKey)){
    if(overviewProject===null) overviewProject=new Set();
    if(overviewProject.has(p)) overviewProject.delete(p);
    else overviewProject.add(p);
    if(overviewProject.size===0) overviewProject=null;
  } else {
    if(overviewProject instanceof Set&&overviewProject.size===1&&overviewProject.has(p)) overviewProject=null;
    else overviewProject=new Set([p]);
  }
  document.querySelectorAll('#overviewProjectSelector .proj-chip').forEach(function(c){
    var val=c.textContent;
    if(val==='Alla') c.classList.toggle('active',overviewProject===null);
    else {
      var proj=Object.entries(PROJECT_META).find(function(e){return e[1].name===val;});
      if(proj) c.classList.toggle('active',overviewProject instanceof Set&&overviewProject.has(proj[0]));
    }
  });
  renderOverview();
}

function renderOverview(){
  var m=getMonth(),y=getYear();
  document.getElementById('overviewSub').textContent=MONTHS_SV[m]+' '+y;
  var projects=ALL_PROJECTS;
  if(overviewFilter==='d2d') projects=GROUP_D2D;
  if(overviewFilter==='tm') projects=GROUP_TM;
  var cardProjects=overviewProject instanceof Set?[...overviewProject]:projects;

  var barColor=function(p){return p>=100?'#2d8a4e':'#f97c5a';};
  var MAL_COLOR='#999';

  var sumTotalProd=0,sumMalProd=0,sumTotalMansdag=0,sumMalMansdag=0,sumTotalTimmar=0,sumMalTimmar=0,sumWorkDays=0;
  var sumMalSnitt=0,sumMalSnittCount=0;
  var days=new Date(y,m+1,0).getDate();
  var sparkLen=0;
  for(var i=1;i<=days;i++){var dd=new Date(y,m,i);if(dd.getDay()!==0&&dd.getDay()!==6) sparkLen++;}
  var allSparkU=[],allSparkM=[];
  for(var i2=0;i2<sparkLen;i2++){allSparkU.push(0);allSparkM.push(0);}

  cardProjects.forEach(function(proj){
    var pd=getProjectData(proj);
    var uRows=Object.values(pd.uData).map(function(r){return normalizeRow(r,'utfall');});
    var mRows=Object.values(pd.mData);
    var mRowsNorm=mRows.map(function(r){return normalizeRow(r,'mal');});
    sumTotalProd+=uRows.reduce(function(s,r){var v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalProd+=mRows.reduce(function(s,r){return s+getProjectMalProd(proj,r);},0);
    sumTotalMansdag+=uRows.reduce(function(s,r){var v=findVal(r,'Antal Mansdagar')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalMansdag+=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l s√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
    sumTotalTimmar+=uRows.reduce(function(s,r){var v=findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
    sumMalTimmar+=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l timmar')??0;return s+(typeof v==='number'?v:0);},0);
    sumWorkDays=Math.max(sumWorkDays,uRows.filter(function(r){return (findVal(r,'Antal Mansdagar')??0)>0;}).length);
    mRowsNorm.forEach(function(r){var v=findVal(r,'M√•l snitt')??0;if(typeof v==='number'&&v>0){sumMalSnitt+=v;sumMalSnittCount++;}});
    var si=0;
    for(var i3=1;i3<=days;i3++){
      var d3=new Date(y,m,i3);if(d3.getDay()===0||d3.getDay()===6) continue;
      var dk=toDateKey(y,m,i3),ur=normalizeRow(pd.uData[dk]||{},'utfall');
      allSparkU[si]+=(findVal(ur,'Produkt')??0);
      allSparkM[si]+=getProjectMalProd(proj,pd.mData[dk]||{});
      si++;
    }
  });

  var sumProdPct=sumMalProd>0?Math.round(sumTotalProd/sumMalProd*100):0;
  var sumAvgProd=sumWorkDays>0?fmt2(sumTotalProd/sumWorkDays):0;
  var sumMalAvgSnitt=sumMalSnittCount>0?fmt2(sumMalSnitt/sumMalSnittCount):0;
  var sumSnittPerTimme=sumTotalTimmar>0?fmt2(sumTotalProd/sumTotalTimmar):0;
  var sumAvgSellers=sumWorkDays>0?fmt2(sumTotalMansdag/sumWorkDays):0;

  var sumMalDaysTotal=0;
  if(sumMalMansdag>0){
    cardProjects.forEach(function(proj){
      var pd2=getProjectData(proj);
      var mn=Object.values(pd2.mData).map(function(r){return normalizeRow(r,'mal');});
      var dc=mn.filter(function(r){var v=findVal(r,'M√•l s√§ljare')??0;return typeof v==='number'&&v>0;}).length;
      sumMalDaysTotal=Math.max(sumMalDaysTotal,dc);
    });
  }
  var taktHtml='';
  if(sumWorkDays>0&&sumMalProd>0&&sumMalDaysTotal>0){
    var expected=sumMalProd*(sumWorkDays/sumMalDaysTotal),diff=sumTotalProd-expected,diffPct=Math.round((diff/expected)*100);
    if(diff>=0) taktHtml='<div style="font-size:11px;margin-top:4px;"><span style="color:#2d8a4e;font-weight:600;">‚ñ≤ On track</span> <span style="color:#666;">(+'+Math.round(diff)+' / +'+diffPct+'%)</span></div>';
    else taktHtml='<div style="font-size:11px;margin-top:4px;"><span style="color:#c0392b;font-weight:600;">‚ñº Off track</span> <span style="color:#666;">('+Math.round(diff)+' / '+diffPct+'%)</span></div>';
  }

  var maxSpark=Math.max.apply(null,allSparkU.concat(allSparkM).concat([1]));
  var W=900,H=52,n=allSparkU.length;
  var px=function(i){return n>1?(i/(n-1))*W:W/2;};
  var py=function(v){return H-(v/maxSpark)*(H-4)-2;};
  var malPath=allSparkM.map(function(v,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(v).toFixed(1);}).join(' ');
  var utfPath=allSparkU.map(function(v,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(v).toFixed(1);}).join(' ');
  var lineColor=sumProdPct>=100?'#2d8a4e':'#f97c5a';

  var filterLabel;
  if(overviewProject instanceof Set&&overviewProject.size>0) filterLabel=[...overviewProject].map(function(p){return PROJECT_META[p]?PROJECT_META[p].name:p;}).join(' + ');
  else if(overviewFilter==='d2d') filterLabel='D2D';
  else if(overviewFilter==='tm') filterLabel='TM';
  else filterLabel='Alla projekt';

  var summaryHtml='<div class="summary-card"><div class="sc-block"><div class="sc-label">Produkter totalt</div><div class="sc-value">'+sumTotalProd+'</div><div class="sc-meta">M√•l: '+(sumMalProd>0?sumMalProd:'‚Äî')+'</div><div class="sc-badge '+(sumProdPct>=100?'badge-green':sumMalProd>0?'badge-red':'badge-neutral')+'">'+(sumMalProd>0?sumProdPct+'% av m√•l':'M√•l saknas')+'</div>'+taktHtml+'</div><div class="sc-block"><div class="sc-label">Snitt per dag</div><div class="sc-value">'+sumAvgProd+'</div><div class="sc-meta">M√•l snitt: '+(sumMalAvgSnitt>0?sumMalAvgSnitt:'‚Äî')+'</div></div><div class="sc-block"><div class="sc-label">Snitt per timme</div><div class="sc-value">'+sumSnittPerTimme+'</div><div class="sc-meta">Totalt '+fmt2(sumTotalTimmar)+' timmar</div></div><div class="sc-block"><div class="sc-label">S√§ljare per dag (snitt)</div><div class="sc-value">'+sumAvgSellers+'</div><div class="sc-meta">Totalt '+sumTotalMansdag+' mansdagar</div></div><div class="sc-spark"><div class="sc-spark-label">'+filterLabel+' ‚Äì daglig produkt, utfall vs m√•l</div><svg width="100%" height="'+H+'" viewBox="0 0 '+W+' '+H+'" preserveAspectRatio="none" style="overflow:visible">'+(sumMalProd>0?'<path d="'+malPath+'" fill="none" stroke="'+MAL_COLOR+'" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/>':'')+'<path d="'+utfPath+'" fill="none" stroke="'+lineColor+'" stroke-width="2"/></svg><div style="display:flex;gap:12px;margin-top:5px;font-size:10px;color:#999;"><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:2px;background:'+lineColor+';border-radius:2px"></span>Utfall</span>'+(sumMalProd>0?'<span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:0;border-top:2px dashed '+MAL_COLOR+'"></span>M√•l</span>':'')+'</div></div></div>';
  document.getElementById('overviewSummaryCard').innerHTML=summaryHtml;

  if(overviewProject instanceof Set&&overviewProject.size===1){
    document.getElementById('overviewGrid').innerHTML='';
    return;
  }

  var sorted=cardProjects.map(function(proj){
    var pd=getProjectData(proj);
    var uRows=Object.values(pd.uData).map(function(r){return normalizeRow(r,'utfall');});
    var mRows=Object.values(pd.mData);
    var totalProd=uRows.reduce(function(s,r){var v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    var malProd=mRows.reduce(function(s,r){return s+getProjectMalProd(proj,r);},0);
    return {proj:proj,totalProd:totalProd,malProd:malProd,pct:malProd>0?Math.round(totalProd/malProd*100):0,hasMal:malProd>0,uData:pd.uData,mData:pd.mData,uRows:uRows,mRows:mRows};
  }).sort(function(a,b){return b.pct-a.pct;});

  var cards=sorted.map(function(item){
    var proj=item.proj,totalProd=item.totalProd,malProd=item.malProd,prodPct=item.pct,projHasMal=item.hasMal,uData=item.uData,mData=item.mData,uRows=item.uRows,mRows=item.mRows;
    var name=PROJECT_META[proj]?PROJECT_META[proj].name:proj;
    var useMansdag=MANSDAG_PROJECTS.has(proj);
    var mRowsNorm=mRows.map(function(r){return normalizeRow(r,'mal');});
    var totalMansdag=uRows.reduce(function(s,r){var v=findVal(r,'Antal Mansdagar')??0;return s+(typeof v==='number'?v:0);},0);
    var malMansdag=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l s√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
    var totalTimmar=uRows.reduce(function(s,r){var v=findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
    var malTimmar=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l timmar')??0;return s+(typeof v==='number'?v:0);},0);
    var workDays=uRows.filter(function(r){return (findVal(r,'Antal Mansdagar')??0)>0;}).length;
    var avgSellers=workDays>0?fmt2(totalMansdag/workDays):0;
    var snittpMansdag=useMansdag?(totalMansdag>0?fmt2(totalProd/totalMansdag):0):(totalTimmar>0?fmt2(totalProd/totalTimmar):0);
    var malSnittSum=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l snitt')??0;return s+(typeof v==='number'?v:0);},0);
    var malSnittDays=mRowsNorm.filter(function(r){return (findVal(r,'M√•l snitt')??0)>0;}).length;
    var malSnitt=malSnittDays>0?fmt2(malSnittSum/malSnittDays):0;
    var secondPct=useMansdag?(malMansdag>0?Math.round(totalMansdag/malMansdag*100):0):(malTimmar>0?Math.round(totalTimmar/malTimmar*100):0);
    var snittpMalPct=malSnitt>0?Math.round(snittpMansdag/malSnitt*100):0;
    var secondLabel=useMansdag?'Mansdagar':'Timmar';
    var secondUtfall=useMansdag?totalMansdag:fmt2(totalTimmar);
    var secondMal=useMansdag?malMansdag:fmt2(malTimmar);
    var snittLabel=useMansdag?'Snitt per mansdag':'Snitt per timme';
    var badgeHtml=!projHasMal?'<span class="compare-badge badge-neutral">M√•l saknas</span>':'<span class="compare-badge '+(prodPct>=100?'badge-green':'badge-neutral')+'">'+prodPct+'% av m√•l</span>';
    var prodMetric=!projHasMal?'<div class="compare-metric"><div class="compare-metric-label">Produkter <span>'+totalProd+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>':'<div class="compare-metric"><div class="compare-metric-label">Produkter <span>'+totalProd+' / '+malProd+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(prodPct,100)+'%;background:'+barColor(prodPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+prodPct+'% av m√•l</div></div>';
    var hasSecondMal=useMansdag?malMansdag>0:malTimmar>0;
    var secondMetric=!hasSecondMal?'<div class="compare-metric"><div class="compare-metric-label">'+secondLabel+' <span>'+secondUtfall+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>':'<div class="compare-metric"><div class="compare-metric-label">'+secondLabel+' <span>'+secondUtfall+' / '+secondMal+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(secondPct,100)+'%;background:'+barColor(secondPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+secondPct+'% av m√•l</div></div>';
    var snittMetric=malSnitt<=0?'<div class="compare-metric"><div class="compare-metric-label">'+snittLabel+' <span>'+snittpMansdag+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas ¬∑ '+avgSellers+' s√§ljare/dag</div></div>':'<div class="compare-metric"><div class="compare-metric-label">'+snittLabel+' <span>'+snittpMansdag+' / '+malSnitt+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(snittpMalPct,100)+'%;background:'+barColor(snittpMalPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+snittpMalPct+'% av m√•l ¬∑ '+avgSellers+' s√§ljare/dag</div></div>';
    var cdays=new Date(y,m+1,0).getDate();
    var sparkP=[],malP2=[];
    for(var i4=1;i4<=cdays;i4++){var d4=new Date(y,m,i4);if(d4.getDay()===0||d4.getDay()===6) continue;var dk4=toDateKey(y,m,i4),ur4=normalizeRow(uData[dk4]||{},'utfall');sparkP.push(fmt2(findVal(ur4,'Produkt')??0));malP2.push(getProjectMalProd(proj,mData[dk4]||{}));}
    var maxVal=Math.max.apply(null,sparkP.concat(malP2).concat([1]));
    var cW=560,cH=44,cn=sparkP.length;
    var cpx=function(i){return cn>1?(i/(cn-1))*cW:cW/2;};
    var cpy=function(v){return cH-(v/maxVal)*(cH-4)-2;};
    var cmalPath=malP2.map(function(v,i){return (i===0?'M':'L')+cpx(i).toFixed(1)+','+cpy(v).toFixed(1);}).join(' ');
    var cutfPath=sparkP.map(function(v,i){return (i===0?'M':'L')+cpx(i).toFixed(1)+','+cpy(v).toFixed(1);}).join(' ');
    var clineColor=prodPct>=100?'#2d8a4e':'#f97c5a';
    var sparkHtml=projHasMal?'<div class="sparkline"><div class="sparkline-label">Daglig produkt ‚Äì utfall vs m√•l</div><svg width="100%" height="'+cH+'" viewBox="0 0 '+cW+' '+cH+'" preserveAspectRatio="none" style="overflow:visible"><path d="'+cmalPath+'" fill="none" stroke="'+MAL_COLOR+'" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/><path d="'+cutfPath+'" fill="none" stroke="'+clineColor+'" stroke-width="2"/></svg><div style="display:flex;gap:12px;margin-top:5px;font-size:10px;color:#999;"><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:2px;background:'+clineColor+';border-radius:2px"></span>Utfall</span><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:0;border-top:2px dashed '+MAL_COLOR+'"></span>M√•l</span></div></div>':'<div class="sparkline"><div class="sparkline-label">Daglig produkt</div><svg width="100%" height="'+cH+'" viewBox="0 0 '+cW+' '+cH+'" preserveAspectRatio="none" style="overflow:visible"><path d="'+cutfPath+'" fill="none" stroke="#f97c5a" stroke-width="2"/></svg></div>';
    return '<div class="compare-card" onclick="switchToDaily(\''+proj+'\')"><div class="compare-card-header"><span class="compare-card-title">'+name+'</span>'+badgeHtml+'</div>'+prodMetric+secondMetric+snittMetric+sparkHtml+'</div>';
  }).join('');

  document.getElementById('overviewGrid').innerHTML=cards;
}

function setDailyGroupFilter(g,el){
  dailyGroup=g;
  document.querySelectorAll('#dailyGroupFilter .filter-pill').forEach(function(p){p.classList.remove('active');});
  el.classList.add('active');
  var projs=g==='d2d'?GROUP_D2D:g==='tm'?GROUP_TM:ALL_PROJECTS;
  dailyProject=new Set([projs[0]]);
  buildProjectChips();
  updateDailyTabs();
  renderDaily();
}

function buildProjectChips(){
  var projs=dailyGroup==='d2d'?GROUP_D2D:dailyGroup==='tm'?GROUP_TM:ALL_PROJECTS;
  var showAll=(dailyGroup==='alla');
  var allActive=projs.every(function(p){return dailyProject.has(p);});
  var sel=document.getElementById('dailyProjectSelector');
  var html='';
  if(showAll) html+='<button class="proj-chip '+(allActive?'active':'')+'" onclick="selectDailyAll()">Alla</button>';
  projs.forEach(function(p){
    html+='<button class="proj-chip '+(dailyProject.has(p)?'active':'')+'" onclick="selectDailyProject(\''+p+'\',this,event)">'+PROJECT_META[p].name+'</button>';
  });
  sel.innerHTML=html;
}

function selectDailyAll(){
  var projs=dailyGroup==='d2d'?GROUP_D2D:dailyGroup==='tm'?GROUP_TM:ALL_PROJECTS;
  dailyProject=new Set(projs);
  buildProjectChips();
  updateDailyTabs();
  renderDaily();
}

function selectDailyProject(p,el,ev){
  if(ev&&(ev.ctrlKey||ev.metaKey)){
    if(dailyProject.has(p)) dailyProject.delete(p);
    else dailyProject.add(p);
    if(dailyProject.size===0) dailyProject.add(p);
  } else {
    if(dailyProject.size===1&&dailyProject.has(p)) return;
    dailyProject=new Set([p]);
  }
  document.querySelectorAll('#dailyProjectSelector .proj-chip').forEach(function(c){
    var val=c.textContent;
    if(val==='Alla'){
      var projs=dailyGroup==='d2d'?GROUP_D2D:dailyGroup==='tm'?GROUP_TM:ALL_PROJECTS;
      c.classList.toggle('active',projs.every(function(pp){return dailyProject.has(pp);}));
    } else {
      var proj=Object.entries(PROJECT_META).find(function(e){return e[1].name===val;});
      if(proj) c.classList.toggle('active',dailyProject.has(proj[0]));
    }
  });
  updateDailyTabs();
  renderDaily();
}

function updateDailyTabs(){
  var multi=dailyProject.size>1;
  var tabs=document.getElementById('dailyViewTabs');
  var fullTab=tabs.querySelector('[data-view="full"]');
  var compareTab=tabs.querySelector('[data-view="compare"]');
  if(multi){
    fullTab.style.display='none';
    compareTab.style.display='';
    if(dailyView==='full') dailyView='compact';
  } else {
    fullTab.style.display='';
    compareTab.style.display='none';
    if(dailyView==='compare') dailyView='full';
  }
  tabs.querySelectorAll('.view-tab').forEach(function(t){
    t.classList.toggle('active',t.dataset.view===dailyView);
  });
}

function setDailyView(v,el){
  dailyView=v;
  document.querySelectorAll('.view-tab').forEach(function(t){t.classList.remove('active');});
  el.classList.add('active');
  renderDaily();
}

function mergeDailyData(projArr){
  var uMerged={},mMerged={};
  projArr.forEach(function(proj){
    var pd=getProjectData(proj);
    for(var [dk,row] of Object.entries(pd.uData)){
      if(!uMerged[dk]) uMerged[dk]={};
      var nr=normalizeRow(row,'utfall');
      for(var [k,v] of Object.entries(nr)){ if(typeof v==='number') uMerged[dk][k]=(uMerged[dk][k]||0)+v; else if(!uMerged[dk][k]) uMerged[dk][k]=v; }
    }
    for(var [dk2,row2] of Object.entries(pd.mData)){
      if(!mMerged[dk2]) mMerged[dk2]={};
      var nr2=normalizeRow(row2,'mal');
      for(var [k2,v2] of Object.entries(nr2)){ if(typeof v2==='number') mMerged[dk2][k2]=(mMerged[dk2][k2]||0)+v2; else if(!mMerged[dk2][k2]) mMerged[dk2][k2]=v2; }
    }
  });
  return {uMerged:uMerged,mMerged:mMerged};
}

function renderDaily(){
  var m=getMonth(),y=getYear();
  var days=new Date(y,m+1,0).getDate();
  var multi=dailyProject.size>1;
  var activeProjArr=[...dailyProject];
  var firstProj=activeProjArr[0];

  if(dailyView==='compare'&&multi){
    document.getElementById('tableWrap').style.display='none';
    document.getElementById('dailyCompareWrap').style.display='block';
    renderDailyCompare(activeProjArr);
    var merged=mergeDailyData(activeProjArr);
    updateStatCards(merged.uMerged,merged.mMerged);
    return;
  }

  document.getElementById('tableWrap').style.display='';
  document.getElementById('dailyCompareWrap').style.display='none';

  var cols=multi?COMPACT_COLS:(dailyView==='compact'?COMPACT_COLS:(PROJECT_COLS[firstProj]||COMPACT_COLS));
  var uData,mData;
  if(multi){
    var mg=mergeDailyData(activeProjArr);
    uData=mg.uMerged; mData=mg.mMerged;
  } else {
    var pd=getProjectData(firstProj);
    uData=pd.uData; mData=pd.mData;
  }

  var e='<span class="empty-cell">‚Äî</span>';
  var savedDaily=_dailyRef;
  _dailyRef=multi?null:firstProj;

  document.getElementById('tableHead').innerHTML='<tr>'+cols.map(function(c){return '<th class="'+(c.goalKey?'goal-col':'')+'">'+c.label+'</th>';}).join('')+'</tr>';

  var lastDataDay=0;
  for(var i=1;i<=days;i++){
    var dk=toDateKey(y,m,i), uRow=uData[dk]||{};
    var hasProd=findVal(uRow,'Produkt')??findVal(uRow,'produkt')??null;
    var hasSaljare=findVal(uRow,'Antal Mansdagar')??findVal(uRow,'Antal S√§ljare')??null;
    if((typeof hasProd==='number'&&hasProd>0)||(typeof hasSaljare==='number'&&hasSaljare>0)) lastDataDay=i;
  }

  var rows='';
  for(var i2=1;i2<=days;i2++){
    var d=new Date(y,m,i2), dayName=DAYS_SV[d.getDay()], weekend=isWeekend(d);
    var dateKey=toDateKey(y,m,i2), uRow2=uData[dateKey]||{}, mRow=mData[dateKey]||{};
    var hasUtfall=Object.keys(uRow2).length>0, hasMal=Object.keys(mRow).length>0;
    var malSaljare=findVal(mRow,'M√•l s√§ljare')||findVal(mRow,'M√•l mansdagar')||0;
    var malTimmar=findVal(mRow,'M√•l timmar')||0;
    var isNonWorkingDay=hasMal&&malSaljare===0&&malTimmar===0;
    var dateStr=i2+' '+MONTHS_SV[m].substring(0,3).toLowerCase();
    var isLastData=i2===lastDataDay;
    var cls=isLastData?'last-data':(weekend||isNonWorkingDay)?'weekend':'';
    var dayLabel=isLastData?'<span class="day-badge">senast</span>'+dayName:dayName;

    var cells=cols.map(function(c,idx){
      if(idx===0) return '<td>'+dayLabel+'</td>';
      if(idx===1) return '<td>'+dateStr+'</td>';
      if(weekend||isNonWorkingDay) return '<td>'+e+'</td>';
      if(c.goalKey){
        var gv=hasMal?resolveDynGoal(c.goalKey,mRow):null;
        return '<td class="goal goal-col">'+(typeof gv==='number'?fmt2(gv):'‚Äî')+'</td>';
      }
      if(c.key){
        var isSnitt=c.key.toLowerCase()==='snitt';
        var isProd=c.key==='Produkt';
        var isSaljare=c.key==='__utfall_saljare__';
        var uv;
        if(isSnitt) uv=hasUtfall?calcSnitt(firstProj,uRow2):null;
        else if(isProd&&(dailyView==='compact'||multi)) uv=hasUtfall?getCompactProd(firstProj,uRow2):null;
        else if(isSaljare) uv=hasUtfall?(findVal(uRow2,'Antal Mansdagar')??findVal(uRow2,'Antal S√§ljare')??null):null;
        else uv=hasUtfall?findVal(uRow2,c.key):null;
        var gk=findGoalKey(cols,c.key);
        var gvRaw=hasMal&&gk?resolveDynGoal(gk,mRow):null;
        var gv2=typeof gvRaw==='number'?fmt2(gvRaw):gvRaw;
        if(uv!==null&&uv!==''){
          var cls2='';
          if(gv2!==null&&typeof uv==='number'&&typeof gv2==='number') cls2=uv>=gv2?'above':'below';
          return '<td'+(cls2?' class="'+cls2+'"':'')+'>'+fmt2(uv)+'</td>';
        }
        return '<td>‚Äî</td>';
      }
      return '<td>‚Äî</td>';
    }).join('');
    rows+='<tr class="'+cls+'">'+cells+'</tr>';
  }

  var summaryCells=cols.map(function(c,idx){
    if(idx===0) return '<td>Summerat</td>';
    if(idx===1) return '<td></td>';
    if(c.goalKey){
      var isSnittGoal=c.goalKey.toLowerCase().indexOf('snitt')>=0;
      if(isSnittGoal){
        var sum=0,count=0;
        Object.values(mData).forEach(function(r){var v=resolveDynGoal(c.goalKey,r);if(typeof v==='number'&&v>0){sum+=v;count++;}});
        return '<td class="goal goal-col">'+(count>0?fmt2(sum/count):'‚Äî')+'</td>';
      }
      var sum2=0;
      Object.values(mData).forEach(function(r){var v=resolveDynGoal(c.goalKey,r);if(typeof v==='number') sum2+=v;});
      return '<td class="goal goal-col">'+(sum2>0?fmt2(sum2):'‚Äî')+'</td>';
    }
    if(c.key){
      if(c.key.toLowerCase()==='snitt'){
        var allR=Object.values(uData);
        var totalP=allR.reduce(function(s,r){var v=findVal(r,'Produkt')??findVal(r,'produkt')??0;return s+(typeof v==='number'?v:0);},0);
        if(SNITT_PER_TIMMAR.has(firstProj)){
          var totalT=allR.reduce(function(s,r){var v=findVal(r,'Timmar')??findVal(r,'timmar')??0;return s+(typeof v==='number'?v:0);},0);
          return '<td>'+(totalT>0?fmt2(totalP/totalT):'‚Äî')+'</td>';
        } else {
          var totalS=allR.reduce(function(s,r){var v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
          return '<td>'+(totalS>0?fmt2(totalP/totalS):'‚Äî')+'</td>';
        }
      }
      if(c.key==='__utfall_saljare__'){
        var sum3=0;
        Object.values(uData).forEach(function(r){var v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;if(typeof v==='number') sum3+=v;});
        return '<td>'+(sum3>0?fmt2(sum3):'‚Äî')+'</td>';
      }
      var sum4=0;
      Object.values(uData).forEach(function(r){var v=findVal(r,c.key);if(typeof v==='number') sum4+=v;});
      return '<td>'+(sum4>0?fmt2(sum4):'‚Äî')+'</td>';
    }
    return '<td>‚Äî</td>';
  }).join('');
  rows+='<tr class="summary-row">'+summaryCells+'</tr>';

  document.getElementById('tableBody').innerHTML=rows;
  _dailyRef=savedDaily;
  updateStatCards(uData,mData);
}

function updateStatCards(uData,mData){
  var uRows=Object.values(uData), mRows=Object.values(mData);
  var firstProj=[...dailyProject][0];
  var getProd=function(r){return findVal(r,'Produkt')??findVal(r,'produkt')??null;};
  var getMalProd=function(r){
    var p=firstProj;
    if(p==='mobil'||p==='fmc'){var h=findVal(r,'M√•l Huvudabb')??0,ea=findVal(r,'M√•l EA')??0;return (typeof h==='number'?h:0)+(typeof ea==='number'?ea:0)||null;}
    if(p==='vip-leads'){var bb=findVal(r,'M√•l BB')??0,mbh=findVal(r,'M√•l MBH')??0;return (typeof bb==='number'?bb:0)+(typeof mbh==='number'?mbh:0)||null;}
    if(p==='retention'||p==='mbh'){var v=findVal(r,'M√•l BB');return typeof v==='number'?v:null;}
    for(var k of ['M√•l S√§lj','M√•l produkt','M√•l Produkt','M√•l s√§lj']){var v2=findVal(r,k);if(typeof v2==='number') return v2;}
    return null;
  };
  var totalProd=uRows.reduce(function(s,r){var v=getProd(r);return s+(typeof v==='number'?v:0);},0);
  var malProd=mRows.reduce(function(s,r){var v=getMalProd(r);return s+(typeof v==='number'?v:0);},0);
  var totalHours=uRows.reduce(function(s,r){var v=findVal(r,'timmar')??findVal(r,'Utfall Timmar')??findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
  var workDays=uRows.filter(function(r){var v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return typeof v==='number'&&v>0;}).length;
  var totalSellers=uRows.reduce(function(s,r){var v=findVal(r,'Antal Mansdagar')??findVal(r,'Antal S√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
  var avgProd=workDays>0?fmt2(totalProd/workDays):0;
  var malAvgProd=(function(){var s=0,c=0;mRows.forEach(function(r){var v=getMalProd(r);if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();
  var avgPerHour=totalHours>0?fmt2(totalProd/totalHours):0;
  var malAvgPerHour=(function(){var s=0,c=0;mRows.forEach(function(r){var v=findVal(r,'M√•l snitt')??findVal(r,'M√•l snitt per mansdag')??null;if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();
  var avgSellers=workDays>0?fmt2(totalSellers/workDays):0;
  var malAvgSellers=(function(){var s=0,c=0;mRows.forEach(function(r){var v=findVal(r,'M√•l s√§ljare')??findVal(r,'M√•l mansdagar')??null;if(typeof v==='number'&&v>0){s+=v;c++;}});return c>0?fmt2(s/c):0;})();

  var setPct=function(vEl,mEl,bEl,val,mal){
    document.getElementById(vEl).textContent=val>0?fmt2(val):'‚Äî';
    document.getElementById(mEl).textContent='M√•l: '+(mal>0?fmt2(mal):'‚Äî');
    var b=document.getElementById(bEl);
    if(val>0&&mal>0){var pct=Math.round(val/mal*100);b.textContent=pct+'% av m√•l';b.className='stat-badge '+(pct>=100?'badge-green':'badge-red');}
    else{b.textContent='Ingen data';b.className='stat-badge badge-neutral';}
  };
  setPct('sc-prod','sc-prod-meta','sc-prod-badge',totalProd,malProd);
  setPct('sc-avg','sc-avg-meta','sc-avg-badge',avgProd,malAvgProd);
  setPct('sc-phtimme','sc-phtimme-meta','sc-phtimme-badge',avgPerHour,malAvgPerHour);
  setPct('sc-sellers','sc-sellers-meta','sc-sellers-badge',avgSellers,malAvgSellers);

  var taktEl=document.getElementById('sc-prod-takt');
  if(taktEl){
    var getMalSaljare=function(r){return findVal(r,'M√•l s√§ljare')??findVal(r,'M√•l mansdagar')??null;};
    var malDaysTotal=mRows.filter(function(r){var v=getMalSaljare(r);return typeof v==='number'&&v>0;}).length;
    if(workDays>0&&malProd>0&&malDaysTotal>0){
      var expected=malProd*(workDays/malDaysTotal), diff=totalProd-expected, diffPct=Math.round((diff/expected)*100);
      if(diff>=0) taktEl.innerHTML='<span style="color:#2d8a4e;font-weight:600;">‚ñ≤ On track</span> <span style="color:#666;">(+'+Math.round(diff)+' / +'+diffPct+'%)</span>';
      else taktEl.innerHTML='<span style="color:#c0392b;font-weight:600;">‚ñº Off track</span> <span style="color:#666;">('+Math.round(diff)+' / '+diffPct+'%)</span>';
    } else taktEl.innerHTML='';
  }
}

function renderDailyCompare(projArr){
  var m=getMonth(),y=getYear(),days=new Date(y,m+1,0).getDate();
  var barColor=function(p){return p>=100?'#2d8a4e':'#f97c5a';};
  var MAL_COLOR='#999';
  var sorted=projArr.map(function(proj){
    var pd=getProjectData(proj);
    var uRows=Object.values(pd.uData).map(function(r){return normalizeRow(r,'utfall');});
    var mRows=Object.values(pd.mData);
    var totalProd=uRows.reduce(function(s,r){var v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    var malProd=mRows.reduce(function(s,r){return s+getProjectMalProd(proj,r);},0);
    return {proj:proj,pct:malProd>0?Math.round(totalProd/malProd*100):0,hasMal:malProd>0};
  }).sort(function(a,b){return b.pct-a.pct;});
  var cards=sorted.map(function(item){
    var proj=item.proj,projHasMal=item.hasMal;
    var name=PROJECT_META[proj]?PROJECT_META[proj].name:proj;
    var pd=getProjectData(proj);
    var uRows=Object.values(pd.uData).map(function(r){return normalizeRow(r,'utfall');});
    var mRows=Object.values(pd.mData);
    var mRowsNorm=mRows.map(function(r){return normalizeRow(r,'mal');});
    var useMansdag=MANSDAG_PROJECTS.has(proj);
    var totalProd=uRows.reduce(function(s,r){var v=findVal(r,'Produkt')??0;return s+(typeof v==='number'?v:0);},0);
    var malProd=mRows.reduce(function(s,r){return s+getProjectMalProd(proj,r);},0);
    var prodPct=malProd>0?Math.round(totalProd/malProd*100):0;
    var totalMansdag=uRows.reduce(function(s,r){var v=findVal(r,'Antal Mansdagar')??0;return s+(typeof v==='number'?v:0);},0);
    var malMansdag=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l s√§ljare')??0;return s+(typeof v==='number'?v:0);},0);
    var totalTimmar=uRows.reduce(function(s,r){var v=findVal(r,'Timmar')??0;return s+(typeof v==='number'?v:0);},0);
    var malTimmar=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l timmar')??0;return s+(typeof v==='number'?v:0);},0);
    var workDays=uRows.filter(function(r){return (findVal(r,'Antal Mansdagar')??0)>0;}).length;
    var avgSellers=workDays>0?fmt2(totalMansdag/workDays):0;
    var snittpMansdag=useMansdag?(totalMansdag>0?fmt2(totalProd/totalMansdag):0):(totalTimmar>0?fmt2(totalProd/totalTimmar):0);
    var malSnittSum=mRowsNorm.reduce(function(s,r){var v=findVal(r,'M√•l snitt')??0;return s+(typeof v==='number'?v:0);},0);
    var malSnittDays=mRowsNorm.filter(function(r){return (findVal(r,'M√•l snitt')??0)>0;}).length;
    var malSnitt=malSnittDays>0?fmt2(malSnittSum/malSnittDays):0;
    var secondPct=useMansdag?(malMansdag>0?Math.round(totalMansdag/malMansdag*100):0):(malTimmar>0?Math.round(totalTimmar/malTimmar*100):0);
    var snittpMalPct=malSnitt>0?Math.round(snittpMansdag/malSnitt*100):0;
    var secondLabel=useMansdag?'Mansdagar':'Timmar';
    var secondUtfall=useMansdag?totalMansdag:fmt2(totalTimmar);
    var secondMal=useMansdag?malMansdag:fmt2(malTimmar);
    var snittLabel=useMansdag?'Snitt per mansdag':'Snitt per timme';
    var badgeHtml=!projHasMal?'<span class="compare-badge badge-neutral">M√•l saknas</span>':'<span class="compare-badge '+(prodPct>=100?'badge-green':'badge-neutral')+'">'+prodPct+'% av m√•l</span>';
    var prodMetric=!projHasMal?'<div class="compare-metric"><div class="compare-metric-label">Produkter <span>'+totalProd+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>':'<div class="compare-metric"><div class="compare-metric-label">Produkter <span>'+totalProd+' / '+malProd+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(prodPct,100)+'%;background:'+barColor(prodPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+prodPct+'% av m√•l</div></div>';
    var hasSecondMal=useMansdag?malMansdag>0:malTimmar>0;
    var secondMetric=!hasSecondMal?'<div class="compare-metric"><div class="compare-metric-label">'+secondLabel+' <span>'+secondUtfall+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas</div></div>':'<div class="compare-metric"><div class="compare-metric-label">'+secondLabel+' <span>'+secondUtfall+' / '+secondMal+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(secondPct,100)+'%;background:'+barColor(secondPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+secondPct+'% av m√•l</div></div>';
    var snittMetric=malSnitt<=0?'<div class="compare-metric"><div class="compare-metric-label">'+snittLabel+' <span>'+snittpMansdag+'</span></div><div style="font-size:11px;color:#999;margin-top:3px;">M√•l saknas ¬∑ '+avgSellers+' s√§ljare/dag</div></div>':'<div class="compare-metric"><div class="compare-metric-label">'+snittLabel+' <span>'+snittpMansdag+' / '+malSnitt+'</span></div><div class="progress-bar-bg"><div class="progress-bar-fill" style="width:'+Math.min(snittpMalPct,100)+'%;background:'+barColor(snittpMalPct)+'"></div></div><div style="font-size:11px;color:#999;margin-top:3px;">'+snittpMalPct+'% av m√•l ¬∑ '+avgSellers+' s√§ljare/dag</div></div>';
    var sparkP=[],malP=[];
    for(var i=1;i<=days;i++){var d=new Date(y,m,i);if(d.getDay()===0||d.getDay()===6) continue;var dk=toDateKey(y,m,i),ur=normalizeRow(pd.uData[dk]||{},'utfall');sparkP.push(fmt2(findVal(ur,'Produkt')??0));malP.push(getProjectMalProd(proj,pd.mData[dk]||{}));}
    var maxVal=Math.max.apply(null,sparkP.concat(malP).concat([1]));
    var W=260,H=44,n=sparkP.length;
    var px=function(i){return n>1?(i/(n-1))*W:W/2;};
    var py=function(v){return H-(v/maxVal)*(H-4)-2;};
    var malPath=malP.map(function(v,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(v).toFixed(1);}).join(' ');
    var utfPath=sparkP.map(function(v,i){return (i===0?'M':'L')+px(i).toFixed(1)+','+py(v).toFixed(1);}).join(' ');
    var lineColor=prodPct>=100?'#2d8a4e':'#f97c5a';
    var sparkHtml=projHasMal?'<div class="sparkline"><div class="sparkline-label">Daglig produkt ‚Äì utfall vs m√•l</div><svg width="100%" height="'+H+'" viewBox="0 0 '+W+' '+H+'" preserveAspectRatio="none" style="overflow:visible"><path d="'+malPath+'" fill="none" stroke="'+MAL_COLOR+'" stroke-width="1.5" stroke-dasharray="4,3" opacity="0.8"/><path d="'+utfPath+'" fill="none" stroke="'+lineColor+'" stroke-width="2"/></svg><div style="display:flex;gap:12px;margin-top:5px;font-size:10px;color:#999;"><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:2px;background:'+lineColor+';border-radius:2px"></span>Utfall</span><span style="display:flex;align-items:center;gap:4px;"><span style="display:inline-block;width:12px;height:0;border-top:2px dashed '+MAL_COLOR+'"></span>M√•l</span></div></div>':'<div class="sparkline"><div class="sparkline-label">Daglig produkt</div><svg width="100%" height="'+H+'" viewBox="0 0 '+W+' '+H+'" preserveAspectRatio="none" style="overflow:visible"><path d="'+utfPath+'" fill="none" stroke="#f97c5a" stroke-width="2"/></svg></div>';
    return '<div class="compare-card"><div class="compare-card-header"><span class="compare-card-title">'+name+'</span>'+badgeHtml+'</div>'+prodMetric+secondMetric+snittMetric+sparkHtml+'</div>';
  }).join('');
  document.getElementById('dailyCompareWrap').innerHTML='<div class="compare-grid">'+cards+'</div>';
}

function convertJsonToStore(raw,store){
  var sheetToProject={};
  for(var [p,meta] of Object.entries(PROJECT_META)) sheetToProject[meta.sheet]=p;
  var normalize=function(s){return s.toLowerCase().replace(/^\d+[\.\d]*\s*/,'').replace(/\./g,'').trim();};
  for(var [sheetName,dateRows] of Object.entries(raw)){
    var proj=sheetToProject[sheetName];
    if(!proj){ var ns=normalize(sheetName); for(var [sheet,p2] of Object.entries(sheetToProject)){if(normalize(sheet)===ns){proj=p2;break;}} }
    if(!proj) continue;
    for(var [dateKey,row] of Object.entries(dateRows)){
      var d=new Date(dateKey); if(isNaN(d)) continue;
      var key=storeKey(proj,d.getFullYear(),d.getMonth());
      if(!store[key]) store[key]={};
      store[key][dateKey]=row;
    }
  }
}

async function loadData(){
  try{
    var results=await Promise.all([
      fetch('data/utfall.json',{cache:'no-store'}),
      fetch('data/mal.json',{cache:'no-store'}),
      fetch('data/last_synced.json',{cache:'no-store'})
    ]);
    if(results[0].ok) convertJsonToStore(await results[0].json(),utfallData);
    if(results[1].ok) convertJsonToStore(await results[1].json(),malData);
    if(results[2].ok){var s=await results[2].json();var el=document.getElementById('lastSynced');if(el&&s.last_synced) el.textContent='Senast synkad: '+s.last_synced;}
  }catch(e){console.warn('Kunde inte ladda data:',e);}
  renderCurrent();
}

buildProjectChips();
buildOverviewProjectChips();
loadData();
</script>
</body>
</html>
