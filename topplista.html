<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIASALES Topplista</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f3f2f0; min-height: 100vh; color: #1a1a1a; font-size: 13px; }

  header {
    background: #fff; border-bottom: 1px solid #ebebeb;
    padding: 0 32px; height: 56px;
    display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100;
  }
  .logo { display: flex; align-items: center; gap: 10px; }
  .logo-icon {
    width: 32px; height: 32px;
    background: linear-gradient(135deg, #f97c5a, #e8503a);
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    color: white; font-weight: 700; font-size: 14px;
  }
  .logo-text { font-weight: 600; font-size: 15px; letter-spacing: 0.5px; }
  .header-right { display: flex; align-items: center; gap: 10px; font-size: 12px; color: #666; }

  .filter-bar {
    display: flex; align-items: center; gap: 10px; padding: 12px 24px;
    background: #fff; border-bottom: 1px solid #ebebeb; flex-wrap: wrap;
  }
  .filter-group { display: flex; align-items: center; gap: 6px; }
  .filter-label { font-size: 11px; font-weight: 600; color: #999; text-transform: uppercase; letter-spacing: 0.5px; }
  .filter-pills { display: flex; gap: 4px; background: #f0f0ee; border-radius: 8px; padding: 3px; }
  .filter-pill {
    padding: 5px 14px; border-radius: 6px; font-size: 12px; cursor: pointer;
    color: #666; font-weight: 500; transition: all 0.15s; border: none; background: none;
  }
  .filter-pill.active { background: #fff; color: #1a1a1a; box-shadow: 0 1px 3px rgba(0,0,0,0.08); font-weight: 600; }
  .filter-pill:hover:not(.active) { color: #333; }

  .proj-chip {
    padding: 5px 12px; border-radius: 20px; font-size: 12px; cursor: pointer;
    border: 1.5px solid #aaa; background: #fff; color: #333; font-weight: 600;
    transition: all 0.15s;
  }
  .proj-chip.active { background: #f97c5a; color: #fff; border-color: #f97c5a; }
  .proj-chip:hover:not(.active) { border-color: #f97c5a; color: #e8503a; }

  select {
    border: 1.5px solid #aaa; border-radius: 8px; padding: 6px 28px 6px 10px;
    font-size: 13px; font-weight: 600; background: #fff; color: #1a1a1a;
    cursor: pointer; outline: none; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%23999'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 8px center;
  }

  .nav-btn {
    width: 28px; height: 28px; border: 1.5px solid #aaa; border-radius: 6px;
    background: #fff; cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 12px; color: #333; font-weight: 600;
  }
  .nav-btn:hover { background: #f7f7f5; }

  .page-section { padding: 20px 24px; }
  .page-title { font-size: 18px; font-weight: 600; margin-bottom: 2px; }
  .page-sub { font-size: 11px; color: #999; margin-bottom: 14px; }

  .month-bar { background: #f0f0ee; border-bottom: 1px solid #ebebeb; }

  /* Podium */
  .podium { display: flex; align-items: flex-end; justify-content: center; gap: 0; margin-bottom: 28px; padding: 20px 20px 0; background: #fff; border: 1px solid #ebebeb; border-radius: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.04); }
  .podium-spot { text-align: center; cursor: default; position: relative; }
  .podium-name { font-size: 12px; font-weight: 700; color: #1a1a1a; max-width: 130px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; margin: 0 auto; }
  .podium-spot.first .podium-name { font-size: 13px; }
  .podium-project { font-size: 10px; color: #999; margin-top: 1px; }
  .podium-value { font-size: 16px; font-weight: 700; margin-top: 3px; color: #1a1a1a; }
  .podium-spot.first .podium-value { font-size: 20px; }
  .podium-meta { font-size: 10px; color: #999; margin-top: 2px; }
  .podium-bar {
    width: 130px; border-radius: 8px 8px 0 0; margin: 10px auto 0;
    display: flex; align-items: center; justify-content: center;
    font-size: 22px; font-weight: 700; color: #a08040; letter-spacing: 0.5px;
    background: linear-gradient(180deg, #fafaf6, #eeeee6);
    border-top: 3px solid #d4b056;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  .podium-spot.first .podium-bar { width: 150px; height: 110px; font-size: 28px; border-top-color: #d4b056; }
  .podium-spot.second .podium-bar { width: 130px; height: 80px; font-size: 24px; border-top-color: #c0c0c0; color: #888; }
  .podium-spot.third .podium-bar { width: 130px; height: 64px; font-size: 22px; border-top-color: #c8956b; color: #a07050; }
  .podium-rank { font-weight: 700; }

  /* Table */
  .table-wrap { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; overflow: auto; }
  table { width: 100%; border-collapse: collapse; }
  th {
    padding: 5px 10px; text-align: left; font-size: 10px; font-weight: 700; color: #999;
    text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #ebebeb;
    background: #fafafa;
  }
  th.right, td.right { text-align: right; }
  th.center, td.center { text-align: center; }
  td {
    padding: 4px 10px; border-bottom: 1px solid #f5f5f5; font-size: 12px;
    color: #333; font-weight: 600;
  }
  tr:last-child td { border-bottom: none; }
  tr:hover td { background: #fafaf8; }

  .rank-cell { width: 40px; text-align: center; font-weight: 700; color: #999; font-size: 14px; }
  .rank-1 { color: #e8a817; }
  .rank-2 { color: #9a9a9a; }
  .rank-3 { color: #b8784a; }

  .seller-cell { display: flex; align-items: center; gap: 8px; }
  .seller-name { font-weight: 600; font-size: 12px; }
  .seller-project { font-size: 10px; color: #999; font-weight: 500; }
  .status-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }
  .dot-green { background: #2d8a4e; }
  .dot-red { background: #c0392b; }

  .value-primary { font-size: 15px; font-weight: 700; color: #1a1a1a; }
  .value-secondary { font-size: 11px; color: #999; font-weight: 500; }

  .bar-cell { width: 120px; }
  .bar-bg { height: 8px; background: #f0f0ee; border-radius: 10px; overflow: hidden; }
  .bar-fill { height: 100%; border-radius: 10px; background: linear-gradient(90deg, #f97c5a, #e8503a); }

  .empty-state { text-align: center; padding: 60px 20px; color: #999; }
  .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state-text { font-size: 15px; font-weight: 500; }

  .stat-row { display: flex; gap: 8px; margin-bottom: 16px; }
  .stat-card { background: #fff; border: 1px solid #ebebeb; border-radius: 12px; padding: 12px 18px; flex: 1; }
  .stat-label { font-size: 10px; color: #999; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .stat-value { font-size: 22px; font-weight: 700; }
  .stat-meta { font-size: 11px; color: #999; margin-top: 2px; }

  @media (max-width: 768px) {
    header { padding: 0 12px; height: 48px; }
    .page-section { padding: 14px 12px; }
    .podium { gap: 6px; }
    .podium-bar { width: 70px !important; }
    .podium-spot.first .podium-bar { width: 80px !important; }
    .podium-name { font-size: 11px; max-width: 80px; }
    .stat-row { flex-wrap: wrap; }
    .stat-card { min-width: calc(50% - 4px); }
    .bar-cell { display: none; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">V</div>
    <span class="logo-text">VIASALES</span>
    <span style="margin-left:12px;font-size:13px;color:#999;font-weight:500;">Topplista</span>
  </div>
  <div class="header-right">
    <span id="lastSynced">Senast synkad: ‚Äî</span>
  </div>
</header>

<div class="filter-bar" style="flex-direction:column;align-items:stretch;gap:8px;">
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
    <div class="filter-group">
      <span class="filter-label">Grupp:</span>
      <div class="filter-pills" id="groupFilter">
        <button class="filter-pill active" onclick="setGroup('alla',this)">Alla</button>
        <button class="filter-pill" onclick="setGroup('d2d',this)">D2D</button>
        <button class="filter-pill" onclick="setGroup('tm',this)">TM</button>
      </div>
    </div>
    <div class="filter-group">
      <span class="filter-label">Period:</span>
      <div class="filter-pills" id="periodFilter">
        <button class="filter-pill" onclick="setPeriod('yesterday',this)">Ig√•r</button>
        <button class="filter-pill" onclick="setPeriod('week',this)">Denna vecka</button>
        <button class="filter-pill active" onclick="setPeriod('month',this)">M√•nad</button>
      </div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
    <div class="filter-group">
      <span class="filter-label">Projekt:</span>
      <div id="projectSelector" style="display:flex;gap:6px;flex-wrap:wrap;"></div>
    </div>
  </div>
</div>
<div class="filter-bar month-bar" style="border-top:none;">
  <div class="filter-group">
    <button class="nav-btn" onclick="changeMonth(-1)">‚óÄ</button>
    <select id="monthSel" onchange="render()">
      <option value="0">Januari</option><option value="1">Februari</option>
      <option value="2">Mars</option><option value="3">April</option>
      <option value="4">Maj</option><option value="5">Juni</option>
      <option value="6">Juli</option><option value="7">Augusti</option>
      <option value="8">September</option><option value="9">Oktober</option>
      <option value="10">November</option><option value="11">December</option>
    </select>
    <select id="yearSel" onchange="render()">
      <option value="2024">2024</option><option value="2025">2025</option>
      <option value="2026">2026</option><option value="2027">2027</option>
    </select>
    <button class="nav-btn" onclick="changeMonth(1)">‚ñ∂</button>
  </div>
</div>

<div class="page-section">
  <div class="page-title">üèÜ Topplista</div>
  <div class="page-sub" id="pageSub">Snitt per timme/mansdag</div>

  <div class="stat-row" id="statRow"></div>
  <div id="podiumWrap"></div>
  <div class="table-wrap" id="tableWrap"></div>
</div>

<script>
const MONTHS_SV=['Januari','Februari','Mars','April','Maj','Juni','Juli','Augusti','September','Oktober','November','December'];
const GROUP_D2D=['Telia D2D','Tele2 Villafiber','Tele2 Koax','LAN','Telia FM'];
const GROUP_TM=['GlobalConnect','Telia Adress√§ndring','Telia VIP Leads','Telia Retention','Telia MBH','Telia Mobil','Telia FMC'];
const MANSDAG_PROJECTS=new Set(['Telia D2D','Telia FM','Tele2 Villafiber','Tele2 Koax','LAN','GlobalConnect']);

const AVATAR_COLORS=['#f97c5a','#e8503a','#4a90d9','#50b983','#9b59b6','#e67e22','#1abc9c','#e74c3c','#3498db','#2ecc71','#8e44ad','#f39c12','#16a085','#c0392b','#2980b9','#27ae60'];

const PROJECT_TO_SHEET={
  'Telia D2D':'1.1. Telia D2D',
  'Tele2 Villafiber':'1.3. Tele2 Villafiber',
  'Tele2 Koax':'1.2. Tele2 Koax',
  'LAN':'1.4. LAN',
  'GlobalConnect':'GlobalConnect',
  'Telia Adress√§ndring':'2.7. Telia Adress√§ndring',
  'Telia VIP Leads':'2.6. Telia VIP Leads',
  'Telia Retention':'2.5. Telia Retention Leads',
  'Telia MBH':'2.2. Telia MBH',
  'Telia Mobil':'2.2. Telia Mobil',
  'Telia FMC':'2.2.1. Telia FMC'
};

function findVal(obj,key){
  if(!obj||!key) return null;
  var lk=key.toLowerCase();
  for(var k of Object.keys(obj)){ if(k.toLowerCase()===lk) return obj[k]; }
  return null;
}

function getProjectSnittMal(project){
  var sheetName=PROJECT_TO_SHEET[project];
  if(!sheetName||!malData[sheetName]) return null;
  var rows=Object.values(malData[sheetName]);
  var sum=0,count=0;
  rows.forEach(function(r){
    var v=findVal(r,'M√•l snitt')??findVal(r,'M√•l snitt per mansdag')??null;
    if(typeof v==='number'&&v>0){sum+=v;count++;}
  });
  return count>0?sum/count:null;
}

let ordersData=[], timmarData=[], malData={};
let filterGroup='alla', filterPeriod='month', filterProject=null;

function getMonth(){ return parseInt(document.getElementById('monthSel').value); }
function getYear(){ return parseInt(document.getElementById('yearSel').value); }
function changeMonth(dir){
  var m=getMonth()+dir, y=getYear();
  if(m<0){m=11;y--;} if(m>11){m=0;y++;}
  document.getElementById('monthSel').value=m;
  document.getElementById('yearSel').value=y;
  render();
}

function avatarColor(name){
  var h=0; for(var i=0;i<name.length;i++) h=name.charCodeAt(i)+((h<<5)-h);
  return AVATAR_COLORS[Math.abs(h)%AVATAR_COLORS.length];
}
function initials(name){
  var p=name.trim().split(/\s+/);
  return p.length>=2?(p[0][0]+p[p.length-1][0]).toUpperCase():name.substring(0,2).toUpperCase();
}
function fmt2(v){ return typeof v==='number'?parseFloat(v.toFixed(2)):v; }

function normalizeProject(p){
  if(!p) return '';
  var s=p.trim();
  // Normalize common variations
  var lower=s.toLowerCase();
  if(lower.includes('telia d2d')||lower.includes('telia fm')) return 'Telia D2D';
  if(lower.includes('villafiber')) return 'Tele2 Villafiber';
  if(lower.includes('koax')) return 'Tele2 Koax';
  if(lower.includes('lan')||lower==='lan') return 'LAN';
  if(lower.includes('globalconnect')) return 'GlobalConnect';
  if(lower.includes('adress√§ndring')||lower.includes('adressandring')) return 'Telia Adress√§ndring';
  if(lower.includes('vip')) return 'Telia VIP Leads';
  if(lower.includes('retention')) return 'Telia Retention';
  if(lower.includes('mbh')) return 'Telia MBH';
  if(lower.includes('fmc')) return 'Telia FMC';
  if(lower.includes('mobil')) return 'Telia Mobil';
  return s;
}

function getDateRange(){
  var m=getMonth(), y=getYear();
  if(filterPeriod==='yesterday'){
    var d=new Date(); d.setDate(d.getDate()-1);
    var dk=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
    return {start:dk,end:dk};
  }
  if(filterPeriod==='week'){
    var now=new Date(), dow=now.getDay(), diff=now.getDate()-dow+(dow===0?-6:1);
    var mon=new Date(now); mon.setDate(diff); mon.setHours(0,0,0,0);
    var sun=new Date(mon); sun.setDate(mon.getDate()+6);
    var s=mon.getFullYear()+'-'+String(mon.getMonth()+1).padStart(2,'0')+'-'+String(mon.getDate()).padStart(2,'0');
    var e=sun.getFullYear()+'-'+String(sun.getMonth()+1).padStart(2,'0')+'-'+String(sun.getDate()).padStart(2,'0');
    return {start:s,end:e};
  }
  var start=y+'-'+String(m+1).padStart(2,'0')+'-01';
  var last=new Date(y,m+1,0).getDate();
  var end=y+'-'+String(m+1).padStart(2,'0')+'-'+String(last).padStart(2,'0');
  return {start:start,end:end};
}

function getProjectList(){
  if(filterGroup==='d2d') return GROUP_D2D;
  if(filterGroup==='tm') return GROUP_TM;
  return [...GROUP_D2D,...GROUP_TM];
}

function setGroup(g,el){
  filterGroup=g; filterProject=null;
  document.querySelectorAll('#groupFilter .filter-pill').forEach(function(p){p.classList.remove('active');});
  el.classList.add('active');
  buildProjectChips(); render();
}
function setPeriod(p,el){
  filterPeriod=p;
  document.querySelectorAll('#periodFilter .filter-pill').forEach(function(b){b.classList.remove('active');});
  el.classList.add('active');
  render();
}

function buildProjectChips(){
  var projs=getProjectList();
  var html='<button class="proj-chip '+(filterProject===null?'active':'')+'" onclick="selectProject(null)">Alla</button>';
  projs.forEach(function(p){
    html+='<button class="proj-chip '+(filterProject===p?'active':'')+'" onclick="selectProject(\''+p+'\')">'+p+'</button>';
  });
  document.getElementById('projectSelector').innerHTML=html;
}
function selectProject(p){
  filterProject=filterProject===p?null:p;
  buildProjectChips(); render();
}

function buildLeaderboard(){
  var range=getDateRange();
  var allowedProjects=new Set(getProjectList());
  if(filterProject) allowedProjects=new Set([filterProject]);

  // Count products per seller+project from orders
  var sellerOrders={};
  ordersData.forEach(function(row){
    var date=row.Datum||row.datum||'';
    if(date<range.start||date>range.end) return;
    var proj=normalizeProject(row.Projekt||row.projekt||'');
    if(!allowedProjects.has(proj)) return;
    var name=(row['S√§ljare']||row['s√§ljare']||'').trim();
    if(!name) return;
    var key=name+'|||'+proj;
    if(!sellerOrders[key]) sellerOrders[key]={name:name,project:proj,products:0};
    sellerOrders[key].products++;
  });

  // Get hours/mansdagar per seller+project from timmar
  var sellerTime={};
  timmarData.forEach(function(row){
    var date=row.Datum||row.datum||'';
    if(date<range.start||date>range.end) return;
    var proj=normalizeProject(row.Projekt||row.projekt||'');
    if(!allowedProjects.has(proj)) return;
    var name=(row['S√§ljare']||row['s√§ljare']||'').trim();
    if(!name) return;
    var key=name+'|||'+proj;
    var hrs=parseFloat(row['Inloggad tid timmar']||row['Inloggad Tid Timmar']||0)||0;
    var mans=parseFloat(row['Mansdagar']||row['mansdagar']||0)||0;
    if(!sellerTime[key]) sellerTime[key]={name:name,project:proj,hours:0,mansdagar:0};
    sellerTime[key].hours+=hrs;
    sellerTime[key].mansdagar+=mans;
  });

  // Merge and calculate snitt
  var allKeys=new Set([...Object.keys(sellerOrders),...Object.keys(sellerTime)]);
  var sellers=[];
  allKeys.forEach(function(key){
    var o=sellerOrders[key]||{products:0};
    var t=sellerTime[key]||{hours:0,mansdagar:0};
    var name=o.name||t.name;
    var proj=o.project||t.project;
    var products=o.products||0;
    var hours=t.hours||0;
    var mansdagar=t.mansdagar||0;
    var useMansdag=MANSDAG_PROJECTS.has(proj);
    var divisor=useMansdag?mansdagar:hours;
    var snitt=divisor>0?products/divisor:0;
    var snittLabel=useMansdag?'per mansdag':'per timme';
    if(products>0||hours>0||mansdagar>0){
      sellers.push({name:name,project:proj,products:products,hours:fmt2(hours),mansdagar:mansdagar,snitt:fmt2(snitt),snittLabel:snittLabel,divisor:fmt2(divisor)});
    }
  });

  // Sort by snitt descending
  sellers.sort(function(a,b){ return b.snitt-a.snitt; });

  return sellers;
}

function render(){
  var m=getMonth(), y=getYear();
  var periodLabel=filterPeriod==='yesterday'?'ig√•r':filterPeriod==='week'?'denna vecka':MONTHS_SV[m]+' '+y;
  var projectLabel=filterProject||'Alla projekt';
  document.getElementById('pageSub').textContent='Snitt per timme/mansdag ¬∑ '+projectLabel+' ¬∑ '+periodLabel;

  var sellers=buildLeaderboard();

  // Stats
  var totalSellers=sellers.length;
  var totalProducts=sellers.reduce(function(s,r){return s+r.products;},0);
  var avgSnitt=totalSellers>0?fmt2(sellers.reduce(function(s,r){return s+r.snitt;},0)/totalSellers):0;
  var topSnitt=sellers.length>0?sellers[0].snitt:0;

  document.getElementById('statRow').innerHTML=
    '<div class="stat-card"><div class="stat-label">Totalt produkter</div><div class="stat-value">'+totalProducts+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">Snitt (alla)</div><div class="stat-value">'+avgSnitt+'</div></div>'+
    '<div class="stat-card"><div class="stat-label">B√§st snitt</div><div class="stat-value">'+topSnitt+'</div></div>';

  // Podium
  if(sellers.length===0){
    document.getElementById('podiumWrap').innerHTML='<div class="empty-state"><div class="empty-state-icon">üìä</div><div class="empty-state-text">Ingen data f√∂r vald period</div></div>';
    document.getElementById('tableWrap').innerHTML='';
    return;
  }

  var top3=sellers.slice(0,3);
  var podiumOrder=top3.length>=3?[top3[1],top3[0],top3[2]]:(top3.length===2?[top3[1],top3[0]]:[top3[0]]);
  var spots=['second','first','third'];
  if(top3.length===2) spots=['second','first'];
  if(top3.length===1) spots=['first'];

  var podiumHtml='<div class="podium">';
  podiumOrder.forEach(function(s,i){
    var spot=spots[i];
    var rank=spot==='first'?1:spot==='second'?2:3;
    var mal=getProjectSnittMal(s.project);
    var dotHtml2=mal!==null?'<span class="status-dot '+(s.snitt>=mal?'dot-green':'dot-red')+'" style="display:inline-block;vertical-align:middle;margin-right:4px;"></span>':'';
    podiumHtml+='<div class="podium-spot '+spot+'">'+
      '<div class="podium-name" title="'+s.name+'">'+s.name+'</div>'+
      '<div class="podium-project">'+s.project+'</div>'+
      '<div class="podium-value">'+dotHtml2+s.snitt+'</div>'+
      '<div class="podium-meta">'+s.products+' prod ¬∑ '+s.divisor+' '+(s.snittLabel.replace('per ',''))+'</div>'+
      '<div class="podium-bar"><span class="podium-rank">'+rank+'</span></div>'+
    '</div>';
  });
  podiumHtml+='</div>';
  document.getElementById('podiumWrap').innerHTML=podiumHtml;

  // Table (from rank 4+, or all if fewer than 4)
  var tableRows=sellers.slice(3);
  var maxSnitt=sellers.length>0?sellers[0].snitt:1;

  var html='<table><thead><tr>'+
    '<th class="center" style="width:36px">#</th>'+
    '<th>S√§ljare</th>'+
    '<th class="right">Prod</th>'+
    '<th class="right">Tim/Mansd</th>'+
    '<th class="right">Snitt</th>'+
    '<th style="width:100px">Niv√•</th>'+
  '</tr></thead><tbody>';

  tableRows.forEach(function(s,i){
    var rank=i+4;
    var pct=maxSnitt>0?Math.round((s.snitt/maxSnitt)*100):0;
    var mal=getProjectSnittMal(s.project);
    var dotHtml=mal!==null?'<span class="status-dot '+(s.snitt>=mal?'dot-green':'dot-red')+'"></span>':'';
    html+='<tr>'+
      '<td class="rank-cell">'+rank+'</td>'+
      '<td><div class="seller-cell">'+dotHtml+'<div class="seller-name">'+s.name+' <span class="seller-project">'+s.project+'</span></div></div></td>'+
      '<td class="right">'+s.products+'</td>'+
      '<td class="right">'+s.divisor+'</td>'+
      '<td class="right"><span class="value-primary">'+s.snitt+'</span></td>'+
      '<td class="bar-cell"><div class="bar-bg"><div class="bar-fill" style="width:'+pct+'%"></div></div></td>'+
    '</tr>';
  });

  html+='</tbody></table>';
  document.getElementById('tableWrap').innerHTML=html;
}

function generateDummyData(){
  var names=['Erik Lindberg','Anna Svensson','Mohamed Ali','Lejla Dizdar','Jonathan Balfe','Sinai Gerzgher','Oscar Pettersson','Sofia Karlsson','David Bj√∂rk','Emma Nilsson','Marcus Holm','Lina Andersson','Felix Johansson','Sara Ekstr√∂m','Viktor Lundqvist','Nadia Hassan','Tobias Falk','Mia Berggren','Adam Rinaldo','Hanna Str√∂m','Leo Wallin','Ida Forsberg','Hugo Sandberg','Elin Nordin','Rasmus √ñberg'];
  var projects=['Telia D2D','Tele2 Villafiber','Tele2 Koax','LAN','GlobalConnect','Telia Adress√§ndring','Telia VIP Leads','Telia Retention','Telia MBH','Telia Mobil','Telia FMC'];
  var orders=[],timmar=[];
  var y=new Date().getFullYear(), m=new Date().getMonth();
  names.forEach(function(name){
    var proj=projects[Math.floor(Math.random()*projects.length)];
    var useMansdag=MANSDAG_PROJECTS.has(proj);
    var daysWorked=Math.floor(Math.random()*15)+5;
    var totalProds=0;
    for(var d=1;d<=daysWorked;d++){
      var date=y+'-'+String(m+1).padStart(2,'0')+'-'+String(Math.min(d+1,28)).padStart(2,'0');
      var hrs=useMansdag?0:(5+Math.random()*3);
      var mans=useMansdag?1:0;
      timmar.push({Datum:date,Projekt:proj,S√§ljare:name,'Inloggad tid timmar':parseFloat(hrs.toFixed(2)),Mansdagar:mans});
      var prods=Math.floor(Math.random()*6);
      totalProds+=prods;
      for(var p=0;p<prods;p++){
        orders.push({Datum:date,Projekt:proj,S√§ljare:name,Produkttyp:'Produkt'});
      }
    }
  });
  return {orders:orders,timmar:timmar};
}

async function loadData(){
  var loaded=false;
  try{
    var [r1,r2,r3,r4]=await Promise.all([
      fetch('data/rawdata_orders.json',{cache:'no-store'}),
      fetch('data/rawdata_timmar.json',{cache:'no-store'}),
      fetch('data/last_synced.json',{cache:'no-store'}),
      fetch('data/mal.json',{cache:'no-store'})
    ]);
    if(r1.ok) ordersData=await r1.json();
    if(r2.ok) timmarData=await r2.json();
    if(r3.ok){var s=await r3.json();if(s.last_synced) document.getElementById('lastSynced').textContent='Senast synkad: '+s.last_synced;}
    if(r4.ok) malData=await r4.json();
    if(ordersData.length>0||timmarData.length>0) loaded=true;
    console.log('Loaded',ordersData.length,'orders,',timmarData.length,'timmar rows');
  }catch(e){console.warn('Kunde inte ladda data, anv√§nder demodata:',e);}

  var now=new Date();
  document.getElementById('monthSel').value=now.getMonth();
  document.getElementById('yearSel').value=now.getFullYear();

  if(!loaded){
    var dummy=generateDummyData();
    ordersData=dummy.orders;
    timmarData=dummy.timmar;
    document.getElementById('lastSynced').textContent='DEMODATA';
    console.log('Using dummy data:',ordersData.length,'orders,',timmarData.length,'timmar');
  }

  buildProjectChips();
  render();
}

loadData();
</script>
</body>
</html>
